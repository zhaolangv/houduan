# 快速OCR题目提取方案

## 问题

- **传统OCR**（PaddleOCR/Tesseract）：速度快（1-3秒），但会识别所有文字（包括界面元素），需要过滤
- **AI OCR**（火山引擎vision）：准确度高，能自动过滤界面元素，但速度慢（15-25秒）

## 解决方案：混合方案

### 流程

1. **第一步：快速OCR识别**（1-3秒）
   - 使用PaddleOCR或Tesseract快速识别所有文字
   - 速度：1-3秒

2. **第二步：规则过滤提取**（<0.1秒）
   - 使用规则过滤掉界面元素（时间、网络状态、导航栏等）
   - 提取题干（选项之前的内容）
   - 提取选项（A/B/C/D格式）
   - 速度：几乎瞬间

3. **第三步：质量评估**
   - 如果提取完整且置信度≥0.7：直接返回（总耗时：1-3秒）
   - 如果提取不完整或置信度<0.7：Fallback到AI（总耗时：15-25秒）

### 优势

- **速度快**：大部分题目可以在1-3秒内完成（比AI快10倍）
- **准确度高**：规则过滤能有效去除界面元素
- **容错性好**：如果规则过滤失败，自动fallback到AI
- **成本低**：减少AI调用次数，节省成本

## 实现细节

### 1. 快速OCR提取器 (`fast_ocr_extractor.py`)

**功能**：
- 清理文字：移除界面元素（时间、网络状态、导航栏等）
- 提取选项：识别A/B/C/D格式的选项
- 提取题干：选项之前的所有内容
- 质量评估：计算置信度和完整性

**规则过滤**：
- 界面元素关键词过滤（时间、网络状态、导航栏等）
- 选项模式匹配（A. B. C. D.格式）
- 位置判断（选项通常在图片下方）

### 2. 混合提取方法 (`question_service_v2.py`)

**方法**：`_extract_question_content_fast()`

**流程**：
```python
1. 尝试快速OCR（PaddleOCR/Tesseract）
   ↓
2. 如果OCR成功且文字足够
   ↓
3. 使用规则过滤提取题目
   ↓
4. 如果提取完整且置信度≥0.7
   → 返回结果（1-3秒）
   ↓
5. 否则Fallback到AI
   → 使用火山引擎vision（15-25秒）
```

## 使用说明

### 安装依赖

```bash
# PaddleOCR（推荐，中文识别效果好）
pip install paddlepaddle paddleocr

# 或 Tesseract（备选）
pip install pytesseract
# Windows需要单独安装Tesseract程序
```

### 配置

无需额外配置，系统会自动检测可用的OCR引擎：
1. 优先使用PaddleOCR
2. 如果PaddleOCR不可用，使用Tesseract
3. 如果都不可用，直接使用AI

### 性能对比

| 方案 | 速度 | 准确度 | 成本 |
|------|------|--------|------|
| 快速OCR+规则 | 1-3秒 | 70-90% | 低 |
| AI OCR | 15-25秒 | 95%+ | 高 |
| 混合方案 | 1-3秒（成功）<br>15-25秒（失败） | 95%+ | 中 |

### 适用场景

**快速OCR+规则适合**：
- 标准格式的题目（A/B/C/D选项）
- 文字清晰的图片
- 界面元素较少的截图

**AI OCR适合**：
- 复杂格式的题目
- 图片质量较差
- 界面元素较多
- 规则过滤失败的题目

## 优化建议

### 1. 提高规则过滤成功率

- **完善界面元素关键词**：根据实际截图添加更多关键词
- **优化选项识别**：支持更多选项格式（①②③④、1/2/3/4等）
- **位置判断优化**：根据图片布局更准确地判断题干和选项位置

### 2. 减少AI调用

- **提高置信度阈值**：如果规则过滤结果较好，可以降低阈值（如0.6）
- **缓存规则过滤结果**：对于相同格式的题目，可以缓存规则

### 3. 并行处理

- **OCR和AI并行**：可以同时启动OCR和AI，谁先完成用谁的结果
- **批量优化**：对于批量处理，可以先用OCR快速筛选，只对失败的用AI

## 测试

运行测试脚本：

```bash
python test_ocr_debug.py
```

查看日志，可以看到：
- `[FastOCR]` - 快速OCR处理日志
- `[QuestionService]` - 提取方法选择日志
- `extraction_method: 'fast_ocr_rule'` - 使用快速OCR+规则
- `extraction_method: 'volcengine_vision'` - 使用AI

## 注意事项

1. **首次使用PaddleOCR**：需要下载模型，可能需要几分钟
2. **内存占用**：PaddleOCR模型会占用一定内存（约500MB）
3. **规则维护**：如果遇到新的界面元素，需要更新过滤规则
4. **Fallback机制**：确保AI服务可用，作为最后的保障

