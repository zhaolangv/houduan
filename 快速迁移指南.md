# 快速迁移指南 - SQLite → PostgreSQL/MySQL

## 🚀 3 步完成迁移

### 步骤 0: 检查数据库配置（推荐）

运行检查脚本，验证配置是否正确：

```bash
python check_database.py
```

脚本会检查：
- ✅ SQLite 数据库文件是否存在
- ✅ 目标数据库连接是否正常
- ✅ 必要的依赖包是否已安装
- ✅ 数据统计信息

### 步骤 1: 配置目标数据库

编辑 `.env` 文件，添加目标数据库连接：

#### 选项 A: Supabase PostgreSQL（推荐）⭐

```env
# 在 Supabase Dashboard → Settings → Database 获取连接字符串
# 重要：必须使用 Connection pooling 模式（端口 6543）
DATABASE_URL=postgresql://postgres:your_password@db.xxxxx.supabase.co:6543/postgres
```

#### 选项 B: 本地 PostgreSQL

```env
DATABASE_URL=postgresql://postgres:password@localhost:5432/gongkao_db
```

#### 选项 C: MySQL

```env
DATABASE_URL=mysql+pymysql://user:password@localhost:3306/gongkao_db?charset=utf8mb4
```

### 步骤 2: 安装依赖（如果需要）

```bash
# PostgreSQL
pip install psycopg2-binary

# MySQL
pip install pymysql
```

### 步骤 3: 运行迁移脚本

```bash
python migrate_database.py
```

脚本会自动：
- ✅ 检测 SQLite 数据库文件
- ✅ 连接到目标数据库
- ✅ 创建表结构（如果不存在）
- ✅ 迁移所有数据
- ✅ 显示迁移进度和结果

---

## 📋 迁移前准备

### 1. 备份 SQLite 数据库（可选但推荐）

```bash
# Windows
copy gongkao_test.db gongkao_test.db.backup

# Linux/macOS
cp gongkao_test.db gongkao_test.db.backup
```

### 2. 检查 SQLite 数据库文件位置

默认位置：`gongkao_test.db`（项目根目录）

如果数据库在其他位置，可以设置环境变量：

```bash
# Windows PowerShell
$env:SQLITE_DB_PATH="D:\path\to\your\database.db"

# Linux/macOS
export SQLITE_DB_PATH="/path/to/your/database.db"
```

### 3. 确认目标数据库连接

可以通过健康检查测试连接：

```python
# test_connection.py
import os
from dotenv import load_dotenv
from sqlalchemy import create_engine, text

load_dotenv()
db_url = os.getenv('DATABASE_URL')

if db_url:
    engine = create_engine(db_url)
    try:
        with engine.connect() as conn:
            conn.execute(text("SELECT 1"))
        print("✅ 数据库连接成功！")
    except Exception as e:
        print(f"❌ 数据库连接失败: {e}")
else:
    print("❌ 未配置 DATABASE_URL")
```

---

## 🔍 迁移过程说明

### 迁移脚本会做什么？

1. **检查连接**
   - ✅ 验证 SQLite 数据库文件存在
   - ✅ 验证目标数据库连接成功

2. **创建表结构**
   - ✅ 在目标数据库中创建 `questions` 和 `answer_versions` 表
   - ✅ 如果表已存在，跳过创建

3. **迁移数据**
   - ✅ 迁移所有题目记录（questions）
   - ✅ 迁移所有答案版本记录（answer_versions）
   - ✅ 自动处理 JSON 字段转换
   - ✅ 跳过已存在的记录（基于 ID）

4. **验证结果**
   - ✅ 统计迁移的记录数
   - ✅ 验证数据完整性

---

## 📊 迁移输出示例

```
======================================================================
🚀 数据库迁移工具
======================================================================

📂 SQLite 数据库: gongkao_test.db
🎯 目标数据库: db.xxxxx.supabase.co:6543/postgres

✅ SQLite 数据库连接成功
✅ 目标数据库 数据库连接成功

======================================================================
📊 数据统计
======================================================================
SQLite questions: 150 条
SQLite answer_versions: 320 条
目标数据库 questions: 0 条
目标数据库 answer_versions: 0 条

======================================================================
⚠️  准备开始迁移，这将复制 SQLite 数据到目标数据库
   已存在的记录将被跳过（基于 ID）

是否继续？(yes/no): yes

======================================================================
🚀 开始迁移数据...
======================================================================

======================================================================
📦 开始迁移 questions 表...
📊 找到 150 条题目记录
✅ 已迁移 10/150 条题目记录 (成功: 10, 跳过: 0, 错误: 0)
✅ 已迁移 20/150 条题目记录 (成功: 20, 跳过: 0, 错误: 0)
...
✅ questions 表迁移完成!
   成功: 150, 跳过: 0, 错误: 0

======================================================================
📦 开始迁移 answer_versions 表...
📊 找到 320 条答案版本记录
✅ 已迁移 50/320 条答案版本记录 (成功: 50, 跳过: 0, 错误: 0)
...
✅ answer_versions 表迁移完成!
   成功: 320, 跳过: 0, 错误: 0

======================================================================
✅ 迁移完成!
======================================================================
📦 迁移题目: 150 条
📦 迁移答案版本: 320 条
⏱️  总耗时: 12.45 秒

======================================================================
🔍 验证迁移结果...
======================================================================
目标数据库 questions: 150 条
目标数据库 answer_versions: 320 条

✅ 迁移完成！现在可以更新 .env 文件中的 DATABASE_URL 并重启应用
```

---

## ⚠️ 注意事项

### 1. 数据安全

- ✅ **迁移不会删除 SQLite 数据**：原始数据库文件保持不变
- ✅ **幂等性**：重复运行脚本会跳过已存在的记录
- ✅ **事务保护**：每条记录独立处理，单条失败不影响其他

### 2. 迁移时间

- **少量数据**（< 1000 条）：几秒到几十秒
- **中等数据**（1000-10000 条）：1-5 分钟
- **大量数据**（> 10000 条）：可能需要更长时间

### 3. 并发迁移

- ✅ 脚本会正确处理关联关系
- ✅ 先迁移 questions，再迁移 answer_versions
- ✅ 外键约束会自动验证

---

## 🔧 故障排查

### 问题 1: 找不到 SQLite 数据库文件

**错误信息**：
```
⚠️ SQLite 数据库文件不存在: gongkao_test.db
```

**解决方案**：
1. 检查数据库文件路径
2. 设置环境变量指定路径：
   ```bash
   # Windows
   $env:SQLITE_DB_PATH="D:\path\to\database.db"
   
   # Linux/macOS
   export SQLITE_DB_PATH="/path/to/database.db"
   ```

### 问题 2: 目标数据库连接失败

**错误信息**：
```
❌ 目标数据库 数据库连接失败: ...
```

**解决方案**：
1. 检查 `DATABASE_URL` 配置是否正确
2. 验证数据库服务是否运行
3. 检查网络连接（如果使用远程数据库）
4. 验证用户名和密码

### 问题 3: 表已存在错误

**解决方案**：
- ✅ 脚本会自动跳过表创建（如果表已存在）
- ✅ 可以手动删除表后重新运行

### 问题 4: JSON 字段解析错误

**解决方案**：
- ✅ 脚本会自动处理 JSON 字段
- ✅ 如果某个字段解析失败，会使用 None 值
- ✅ 不会影响其他记录的迁移

---

## ✅ 迁移后验证

### 1. 检查数据数量

运行迁移脚本后，最后会显示数据统计，确认迁移成功。

### 2. 测试应用

启动应用并测试：

```bash
python app.py
```

查看日志确认连接成功：
```
✅ 数据库连接成功！
✅ 数据库表已就绪！
```

### 3. 健康检查

```bash
curl http://localhost:5000/api/health
```

应该显示：
```json
{
  "status": "healthy",
  "checks": {
    "database": {
      "status": "connected",
      "type": "postgresql"
    }
  }
}
```

### 4. 测试查询

通过 API 查询数据，确认数据完整。

---

## 🎯 迁移后步骤

### 1. 保留 SQLite 备份

迁移成功后，建议保留 SQLite 数据库文件作为备份。

### 2. 更新配置

`.env` 文件中的 `DATABASE_URL` 已经配置为目标数据库，无需修改。

### 3. 重启应用

```bash
python app.py
```

### 4. 验证功能

- ✅ 查询题目
- ✅ 批量处理
- ✅ 数据写入

---

## 📄 相关文档

- `数据库选择与迁移指南.md` - 详细的数据库选择和配置说明
- `数据库连接池优化说明.md` - 连接池优化详情
- `migrate_database.py` - 迁移脚本源码

---

## 💡 提示

1. **首次迁移前建议备份**：虽然迁移不会删除原始数据，但备份是良好的习惯

2. **迁移可以在任何时候运行**：脚本会跳过已存在的记录，可以安全地多次运行

3. **支持增量迁移**：如果 SQLite 中有新数据，可以再次运行脚本迁移新数据

4. **迁移后可以删除 SQLite**：确认一切正常后，可以删除 SQLite 文件（但建议先保留一段时间）

---

## ❓ 常见问题

### Q: 迁移需要多长时间？

**A**: 取决于数据量，通常：
- 100 条记录：< 10 秒
- 1000 条记录：< 1 分钟
- 10000 条记录：< 5 分钟

### Q: 迁移会删除原始数据吗？

**A**: 不会。SQLite 数据库文件保持不变，所有数据都会保留。

### Q: 可以部分迁移吗？

**A**: 迁移脚本会迁移所有数据。如果需要部分迁移，可以修改脚本或手动操作。

### Q: 迁移失败怎么办？

**A**: 
1. 查看错误日志
2. 修复问题
3. 重新运行脚本（已迁移的记录会被跳过）

### Q: 如何回滚到 SQLite？

**A**: 只需将 `.env` 中的 `DATABASE_URL` 改回 SQLite 或删除该配置即可。
