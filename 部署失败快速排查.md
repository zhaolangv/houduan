# 部署失败快速排查指南

## 🚨 看到 "There was an error deploying from source" 错误？

按照以下步骤快速排查：

---

## 📋 第一步：查看详细错误日志

### Railway平台

1. 登录 https://railway.app
2. 进入你的项目
3. 点击 **Deployments** 标签
4. 点击失败的部署（红色标记）
5. 查看 **Build Logs** 和 **Deploy Logs**

**关键信息**：
- 在哪个步骤失败？（安装依赖？启动应用？）
- 具体的错误信息是什么？

---

## 🔍 第二步：常见错误及快速修复

### 错误1: 依赖安装失败

**错误信息示例**：
```
ERROR: Could not find a version that satisfies the requirement torch==2.1.0
ERROR: No matching distribution found for xxx
```

**快速修复**：
1. 检查 `requirements.txt` 中的版本号
2. 确保已使用灵活版本（`>=` 而不是 `==`）
3. 如果仍有问题，查看下方"临时解决方案"

### 错误2: 内存不足（Killed）

**错误信息**：
```
Killed
```

**原因**：torch等大包安装时内存不足

**快速修复**：
- 临时注释掉不需要的大包（见下方）

### 错误3: 模块导入失败

**错误信息**：
```
ModuleNotFoundError: No module named 'xxx'
```

**快速修复**：
- 检查 `requirements.txt` 是否包含所有依赖
- 确认没有拼写错误

### 错误4: 启动命令错误

**错误信息**：
```
Address already in use
gunicorn: command not found
```

**快速修复**：
- 确认 `Procfile` 或 `railway.json` 中的启动命令正确
- 确认使用 `$PORT` 而不是固定端口

---

## 🛠️ 临时解决方案（如果torch导致问题）

如果torch相关包导致部署失败，且你**暂时不需要embedding功能**，可以临时注释掉：

### 修改 requirements.txt

```txt
flask==3.0.0
flask-sqlalchemy==3.1.1
Pillow==10.1.0
imagehash==4.3.1
requests==2.31.0
python-dotenv==1.0.0
openai==2.8.1
psycopg2-binary==2.9.9
# sentence-transformers==2.2.2  # 临时注释
# torch>=2.2.0,<3.0.0  # 临时注释
# torchvision>=0.17.0,<1.0.0  # 临时注释
# numpy>=1.24.0,<2.0.0  # 临时注释（如果其他包不需要）
tkinterdnd2==0.3.0
supabase>=2.0.0
gunicorn>=21.2.0
flask-cors>=4.0.0
```

**注意**：注释掉torch后，embedding功能将不可用，但核心的题目分析功能仍然可以工作。

---

## ✅ 第三步：验证修复

### 1. 本地测试

```bash
# 创建干净的虚拟环境
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt

# 测试启动
python app.py
```

### 2. 提交并推送

```bash
git add requirements.txt
git commit -m "修复部署依赖问题"
git push origin main
```

### 3. 重新部署

Railway会自动检测到新的提交并重新部署。

---

## 📝 检查清单

部署前确认：

- [ ] `requirements.txt` 中所有版本号都是可用的
- [ ] 已测试本地安装：`pip install -r requirements.txt`
- [ ] `Procfile` 或 `railway.json` 中的启动命令正确
- [ ] 所有环境变量已在Railway中配置
- [ ] `.gitignore` 已排除 `.env` 文件
- [ ] 代码已推送到GitHub

---

## 🔧 如果仍然失败

### 1. 查看完整日志

复制Railway中的完整错误日志，检查：
- 错误发生在哪个阶段？
- 具体的错误信息是什么？

### 2. 简化依赖

创建一个最小版本的 `requirements.txt`：

```txt
# 最小依赖（仅核心功能）
flask>=3.0.0
flask-sqlalchemy>=3.1.0
psycopg2-binary>=2.9.9
python-dotenv>=1.0.0
gunicorn>=21.2.0
flask-cors>=4.0.0
Pillow>=10.0.0
requests>=2.31.0
openai>=2.8.0
supabase>=2.0.0
```

先确保应用能部署成功，再逐步添加其他依赖。

### 3. 检查Python版本

Railway默认使用Python 3.12，某些包可能不兼容。

可以在项目根目录创建 `runtime.txt`：

```txt
python-3.11.0
```

---

## 📞 需要帮助？

如果以上方法都无法解决，请提供：

1. **完整的错误日志**（从Railway复制）
2. **requirements.txt 内容**
3. **railway.json 或 Procfile 内容**
4. **Python版本**（如果指定了runtime.txt）

---

## 🎯 快速修复命令

```bash
# 1. 检查依赖
pip install -r requirements.txt

# 2. 测试启动
python app.py

# 3. 提交修复
git add .
git commit -m "修复部署问题"
git push origin main
```

---

**提示**：大多数部署失败都是依赖问题。先确保本地能正常安装和运行，再部署到Railway。
