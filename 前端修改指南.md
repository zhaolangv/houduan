# å‰ç«¯ä¿®æ”¹æŒ‡å— - æ‰¹é‡æå–æ¥å£

## ğŸ“‹ é—®é¢˜è¯Šæ–­

æ ¹æ®é”™è¯¯æ—¥å¿—ï¼š
```
[ERROR] [API] âŒ æ‰€æœ‰å›¾ç‰‡è§£ç å¤±è´¥: å›¾ç‰‡1: ç¼ºå°‘dataå­—æ®µ, å›¾ç‰‡2: ç¼ºå°‘dataå­—æ®µ
```

**é—®é¢˜åŸå› **ï¼šå‰ç«¯å‘é€çš„JSONæ•°æ®ä¸­ï¼Œ`images` æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ç¼ºå°‘ `data` å­—æ®µã€‚

---

## âœ… éœ€è¦å‰ç«¯ä¿®æ”¹

### å½“å‰é—®é¢˜

å‰ç«¯å¯èƒ½å‘é€äº†ä»¥ä¸‹æ ¼å¼ä¹‹ä¸€ï¼ˆéƒ½æ˜¯é”™è¯¯çš„ï¼‰ï¼š

#### é”™è¯¯æ ¼å¼1: åªå‘é€æ–‡ä»¶å
```json
{
  "images": [
    { "filename": "é¢˜ç›®1.jpg" },  // âŒ ç¼ºå°‘ data å­—æ®µ
    { "filename": "é¢˜ç›®2.jpg" }   // âŒ ç¼ºå°‘ data å­—æ®µ
  ]
}
```

#### é”™è¯¯æ ¼å¼2: dataå­—æ®µä¸ºç©ºæˆ–ä¸å­˜åœ¨
```json
{
  "images": [
    { "filename": "é¢˜ç›®1.jpg", "data": "" },  // âŒ dataä¸ºç©º
    { "filename": "é¢˜ç›®2.jpg" }               // âŒ ç¼ºå°‘ data å­—æ®µ
  ]
}
```

---

## âœ… æ­£ç¡®çš„æ ¼å¼

### å¿…é¡»åŒ…å«çš„å­—æ®µ

```json
{
  "images": [
    {
      "filename": "é¢˜ç›®1.jpg",
      "data": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD..."
    },
    {
      "filename": "é¢˜ç›®2.jpg",
      "data": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD..."
    }
  ],
  "max_workers": 10
}
```

**å…³é”®ç‚¹**ï¼š
1. âœ… `images` å¿…é¡»æ˜¯æ•°ç»„
2. âœ… æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ å¿…é¡»æ˜¯å¯¹è±¡ï¼ˆå­—å…¸ï¼‰
3. âœ… æ¯ä¸ªå¯¹è±¡**å¿…é¡»**æœ‰ `filename` å­—æ®µ
4. âœ… æ¯ä¸ªå¯¹è±¡**å¿…é¡»**æœ‰ `data` å­—æ®µï¼ˆå®Œæ•´çš„data URLæ ¼å¼ï¼‰
5. âœ… `data` å­—æ®µçš„å€¼å¿…é¡»æ˜¯å®Œæ•´çš„ base64 data URLï¼Œæ ¼å¼ï¼š`data:image/jpeg;base64,xxxxx`

---

## ğŸ”§ å‰ç«¯ä¿®æ”¹æ­¥éª¤

### æ­¥éª¤1: æ£€æŸ¥å›¾ç‰‡è½¬æ¢å‡½æ•°

ç¡®ä¿ä½¿ç”¨ `FileReader.readAsDataURL()` æ–¹æ³•ï¼š

```javascript
// âœ… æ­£ç¡®çš„æ–¹æ³•
function convertImageToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result); // ç»“æœæ ¼å¼: "data:image/jpeg;base64,xxx"
    reader.onerror = reject;
    reader.readAsDataURL(file); // å…³é”®ï¼šä½¿ç”¨ readAsDataURL
  });
}

// âŒ é”™è¯¯ï¼šä¸è¦ä½¿ç”¨ readAsArrayBuffer
// reader.readAsArrayBuffer(file); // è¿™ä¼šè¿”å› ArrayBufferï¼Œä¸æ˜¯ base64 å­—ç¬¦ä¸²
```

### æ­¥éª¤2: æ„å»ºæ­£ç¡®çš„æ•°æ®æ ¼å¼

```javascript
async function prepareImagesData(files) {
  const imagesData = [];
  
  for (const file of files) {
    // 1. è½¬æ¢ä¸ºbase64
    const base64Data = await convertImageToBase64(file);
    
    // 2. éªŒè¯æ ¼å¼
    if (!base64Data || !base64Data.startsWith('data:image')) {
      console.error(`æ–‡ä»¶ ${file.name} è½¬æ¢å¤±è´¥æˆ–æ ¼å¼ä¸æ­£ç¡®`);
      continue;
    }
    
    // 3. æ·»åŠ åˆ°æ•°ç»„ï¼ˆç¡®ä¿åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µï¼‰
    imagesData.push({
      filename: file.name,        // âœ… å¿…éœ€
      data: base64Data,           // âœ… å¿…éœ€ï¼ˆå®Œæ•´çš„data URLï¼‰
      // ocr_text: null,          // âŒ å¯é€‰å­—æ®µ
    });
  }
  
  return imagesData;
}
```

### æ­¥éª¤3: å‘é€è¯·æ±‚å‰éªŒè¯æ•°æ®

```javascript
async function batchExtract(files) {
  // 1. å‡†å¤‡æ•°æ®
  const imagesData = await prepareImagesData(files);
  
  // 2. éªŒè¯æ•°æ®æ ¼å¼ï¼ˆè°ƒè¯•ç”¨ï¼‰
  console.log('å‡†å¤‡å‘é€çš„æ•°æ®:', {
    imagesCount: imagesData.length,
    images: imagesData.map(img => ({
      filename: img.filename,
      hasData: !!img.data,
      dataLength: img.data ? img.data.length : 0,
      dataPrefix: img.data ? img.data.substring(0, 30) : 'N/A'
    }))
  });
  
  // 3. ç¡®ä¿æ‰€æœ‰å›¾ç‰‡éƒ½æœ‰dataå­—æ®µ
  const missingData = imagesData.filter(img => !img.data);
  if (missingData.length > 0) {
    console.error('ä»¥ä¸‹å›¾ç‰‡ç¼ºå°‘dataå­—æ®µ:', missingData.map(img => img.filename));
    throw new Error('éƒ¨åˆ†å›¾ç‰‡ç¼ºå°‘dataå­—æ®µï¼Œè¯·æ£€æŸ¥å›¾ç‰‡è½¬æ¢é€»è¾‘');
  }
  
  // 4. å‘é€è¯·æ±‚
  const response = await fetch('http://localhost:5000/api/questions/extract/batch', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      images: imagesData,
      max_workers: 10
    })
  });
  
  return response.json();
}
```

---

## ğŸ“ å®Œæ•´ç¤ºä¾‹ä»£ç 

### React Hook ç¤ºä¾‹

```jsx
import { useState } from 'react';

function useBatchExtract() {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  
  const convertToBase64 = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file); // âœ… ä½¿ç”¨ readAsDataURL
    });
  };
  
  const batchExtract = async (files) => {
    setLoading(true);
    setError(null);
    
    try {
      // 1. è½¬æ¢æ‰€æœ‰å›¾ç‰‡ä¸ºbase64
      const imagesData = await Promise.all(
        files.map(async (file) => {
          const base64 = await convertToBase64(file);
          
          // éªŒè¯æ ¼å¼
          if (!base64.startsWith('data:image')) {
            throw new Error(`å›¾ç‰‡ ${file.name} æ ¼å¼ä¸æ­£ç¡®`);
          }
          
          // âœ… ç¡®ä¿åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µ
          return {
            filename: file.name,
            data: base64
          };
        })
      );
      
      // 2. å‘é€è¯·æ±‚
      const response = await fetch('http://localhost:5000/api/questions/extract/batch', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          images: imagesData,
          max_workers: 10
        })
      });
      
      const result = await response.json();
      
      if (!response.ok || !result.success) {
        throw new Error(result.error || 'æ‰¹é‡æå–å¤±è´¥');
      }
      
      return result;
    } catch (err) {
      setError(err.message);
      throw err;
    } finally {
      setLoading(false);
    }
  };
  
  return { batchExtract, loading, error };
}
```

### Vue 3 Composition API ç¤ºä¾‹

```vue
<script setup>
import { ref } from 'vue';

const loading = ref(false);
const error = ref(null);

const convertToBase64 = (file) => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file); // âœ… ä½¿ç”¨ readAsDataURL
  });
};

const batchExtract = async (files) => {
  loading.value = true;
  error.value = null;
  
  try {
    // 1. è½¬æ¢æ‰€æœ‰å›¾ç‰‡
    const imagesData = await Promise.all(
      Array.from(files).map(async (file) => {
        const base64 = await convertToBase64(file);
        
        if (!base64.startsWith('data:image')) {
          throw new Error(`å›¾ç‰‡ ${file.name} æ ¼å¼ä¸æ­£ç¡®`);
        }
        
        // âœ… ç¡®ä¿åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µ
        return {
          filename: file.name,
          data: base64
        };
      })
    );
    
    // 2. å‘é€è¯·æ±‚
    const response = await fetch('http://localhost:5000/api/questions/extract/batch', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        images: imagesData,
        max_workers: 10
      })
    });
    
    const result = await response.json();
    
    if (!response.ok || !result.success) {
      throw new Error(result.error || 'æ‰¹é‡æå–å¤±è´¥');
    }
    
    return result;
  } catch (err) {
    error.value = err.message;
    throw err;
  } finally {
    loading.value = false;
  }
};
</script>
```

---

## ğŸ” è°ƒè¯•æ¸…å•

ä¿®æ”¹å‰ç«¯ä»£ç åï¼Œè¯·æ£€æŸ¥ï¼š

- [ ] æ˜¯å¦ä½¿ç”¨ `FileReader.readAsDataURL()` è€Œä¸æ˜¯ `readAsArrayBuffer()`
- [ ] æ¯ä¸ªå›¾ç‰‡å¯¹è±¡æ˜¯å¦åŒ…å« `filename` å­—æ®µ
- [ ] æ¯ä¸ªå›¾ç‰‡å¯¹è±¡æ˜¯å¦åŒ…å« `data` å­—æ®µ
- [ ] `data` å­—æ®µçš„å€¼æ˜¯å¦ä»¥ `data:image/` å¼€å¤´
- [ ] `images` æ˜¯å¦æ˜¯æ•°ç»„ç±»å‹
- [ ] æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ æ˜¯å¦æ˜¯å¯¹è±¡ç±»å‹

---

## ğŸ“ å¦‚æœè¿˜æœ‰é—®é¢˜

å¦‚æœä¿®æ”¹åä»ç„¶æœ‰é—®é¢˜ï¼Œè¯·ï¼š

1. **æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°**ï¼šæŸ¥çœ‹æ˜¯å¦æœ‰JavaScripté”™è¯¯
2. **æ‰“å°å‘é€çš„æ•°æ®**ï¼šåœ¨å‘é€å‰æ‰“å° `imagesData`ï¼Œç¡®ä¿æ ¼å¼æ­£ç¡®
3. **æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—**ï¼šæŸ¥çœ‹åç«¯è¿”å›çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯
4. **å‚è€ƒæ–‡æ¡£**ï¼šæŸ¥çœ‹ `å‰ç«¯JSONæ ¼å¼è¯´æ˜.md` è·å–æ›´å¤šç¤ºä¾‹

---

## ğŸ“„ ç›¸å…³æ–‡æ¡£

- `å‰ç«¯JSONæ ¼å¼è¯´æ˜.md` - è¯¦ç»†çš„æ ¼å¼è¯´æ˜å’Œç¤ºä¾‹
- `å‰ç«¯APIæ¥å£æ–‡æ¡£.md` - å®Œæ•´çš„APIæ¥å£æ–‡æ¡£
