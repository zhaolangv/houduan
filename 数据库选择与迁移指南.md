# 数据库选择与迁移指南

## 📋 是否需要切换到 PostgreSQL/MySQL？

### 当前情况分析

根据您的使用场景，建议如下：

#### ✅ **可以继续使用 SQLite**（如果满足以下条件）

- 并发量 ≤ 20
- 数据量 < 10GB
- 主要是读取操作
- **开发/测试环境**

#### ⚠️ **建议切换到 PostgreSQL/MySQL**（如果满足以下任一条件）

- ✅ **高并发批量处理**（并发数 > 20）
- ✅ **生产环境部署**
- ✅ **需要频繁写入操作**
- ✅ **数据量较大**（> 10GB）
- ✅ **需要远程访问**
- ✅ **需要数据库备份和恢复**

---

## 🔍 当前场景判断

根据您遇到的连接池问题：

### 如果您经常进行批量处理

**建议**：✅ **切换到 PostgreSQL 或 MySQL**

**原因**：
1. SQLite 对并发写入支持有限（会锁库）
2. 批量处理时多个任务同时写入，SQLite 容易锁库
3. PostgreSQL/MySQL 支持真正的并发读写

### 如果只是偶尔批量处理

**建议**：可以先用 SQLite 试试，如果：
- 仍然出现 `database is locked` 错误
- 连接池问题无法解决

则再切换到 PostgreSQL/MySQL。

---

## 🚀 推荐方案

### 方案1: Supabase PostgreSQL（推荐）⭐

**优点**：
- ✅ 免费额度充足（500MB 数据库，每月 50万次请求）
- ✅ 自动备份
- ✅ 云端托管，无需自己维护
- ✅ 支持连接池模式
- ✅ 提供 Web 管理界面

**适用场景**：生产环境、需要远程访问

### 方案2: 本地 PostgreSQL

**优点**：
- ✅ 完全控制
- ✅ 无网络延迟
- ✅ 免费

**适用场景**：本地开发、有服务器资源

### 方案3: MySQL

**优点**：
- ✅ 广泛使用
- ✅ 资源占用较少
- ✅ 配置相对简单

**适用场景**：已有 MySQL 环境、熟悉 MySQL

---

## 📝 迁移步骤

### 方式1: 切换到 Supabase PostgreSQL（推荐）

#### 步骤1: 创建 Supabase 项目

1. 访问 [Supabase](https://supabase.com/)
2. 注册/登录账号
3. 创建新项目

#### 步骤2: 获取数据库连接字符串

1. 进入项目 Dashboard
2. 点击 **Settings** → **Database**
3. 找到 **Connection string** 部分
4. 选择 **Connection pooling** 模式
5. 复制连接字符串，格式：
   ```
   postgresql://postgres:[YOUR-PASSWORD]@db.[PROJECT-REF].supabase.co:6543/postgres
   ```

#### 步骤3: 配置环境变量

编辑 `.env` 文件：

```env
# 删除或注释掉旧的 DATABASE_URL（如果有）
# DATABASE_URL=sqlite:///gongkao_test.db

# 添加 Supabase PostgreSQL 连接
DATABASE_URL=postgresql://postgres:your_password@db.xxxxx.supabase.co:6543/postgres
```

**重要提示**：
- 端口必须是 **6543**（连接池模式）
- 不要使用 5432 端口（直连模式，不支持连接池）

#### 步骤4: 安装依赖（如需要）

```bash
pip install psycopg2-binary
```

#### 步骤5: 启动应用

```bash
python app.py
```

应用会自动：
- ✅ 连接到 Supabase PostgreSQL
- ✅ 创建表结构
- ✅ 使用优化后的连接池配置

#### 步骤6: 迁移数据（可选）

如果需要迁移 SQLite 数据到 PostgreSQL：

```python
# 创建迁移脚本 migrate_to_postgres.py
from sqlalchemy import create_engine
from models_v2 import Question, AnswerVersion
import json

# SQLite 源数据库
sqlite_engine = create_engine('sqlite:///gongkao_test.db')

# PostgreSQL 目标数据库
postgres_url = os.getenv('DATABASE_URL')
postgres_engine = create_engine(postgres_url)

# 迁移逻辑
# ...（具体迁移代码）
```

---

### 方式2: 切换到本地 PostgreSQL

#### 步骤1: 安装 PostgreSQL

**Windows**:
- 下载安装包：https://www.postgresql.org/download/windows/
- 或使用包管理器：`choco install postgresql`

**macOS**:
```bash
brew install postgresql
brew services start postgresql
```

**Linux**:
```bash
sudo apt-get install postgresql postgresql-contrib
sudo systemctl start postgresql
```

#### 步骤2: 创建数据库

```bash
# 登录 PostgreSQL
psql -U postgres

# 创建数据库
CREATE DATABASE gongkao_db;

# 创建用户（可选）
CREATE USER gongkao_user WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE gongkao_db TO gongkao_user;

# 退出
\q
```

#### 步骤3: 配置环境变量

编辑 `.env` 文件：

```env
DATABASE_URL=postgresql://postgres:your_password@localhost:5432/gongkao_db
```

#### 步骤4: 安装依赖

```bash
pip install psycopg2-binary
```

#### 步骤5: 启动应用

```bash
python app.py
```

---

### 方式3: 切换到 MySQL

#### 步骤1: 安装 MySQL

**Windows**:
- 下载安装包：https://dev.mysql.com/downloads/mysql/
- 或使用包管理器：`choco install mysql`

**macOS**:
```bash
brew install mysql
brew services start mysql
```

**Linux**:
```bash
sudo apt-get install mysql-server
sudo systemctl start mysql
```

#### 步骤2: 创建数据库

```bash
# 登录 MySQL
mysql -u root -p

# 创建数据库
CREATE DATABASE gongkao_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建用户（可选）
CREATE USER 'gongkao_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON gongkao_db.* TO 'gongkao_user'@'localhost';
FLUSH PRIVILEGES;

# 退出
EXIT;
```

#### 步骤3: 配置环境变量

编辑 `.env` 文件：

```env
DATABASE_URL=mysql+pymysql://gongkao_user:your_password@localhost:3306/gongkao_db?charset=utf8mb4
```

#### 步骤4: 安装依赖

```bash
pip install pymysql
```

#### 步骤5: 启动应用

```bash
python app.py
```

---

## ⚡ 性能对比

### SQLite（当前）

```
并发写入：❌ 不支持（会锁库）
并发读取：✅ 支持（有限）
连接池：✅ 已优化（20/30）
适用场景：开发、小规模
```

### PostgreSQL/MySQL

```
并发写入：✅ 完全支持
并发读取：✅ 完全支持
连接池：✅ 已优化（20/30）
适用场景：生产、大规模
```

---

## 🔄 迁移后验证

### 1. 检查连接

启动应用后，查看日志：

```
✅ 数据库连接成功！
✅ 数据库表已就绪！
```

### 2. 健康检查

```bash
curl http://localhost:5000/api/health
```

应该显示：

```json
{
  "status": "healthy",
  "checks": {
    "database": {
      "status": "connected",
      "type": "postgresql"  // 或 "mysql"
    }
  }
}
```

### 3. 测试批量处理

运行批量处理，应该不再出现连接池错误。

---

## ⚠️ 注意事项

### SQLite → PostgreSQL/MySQL

1. **数据类型差异**：
   - SQLite 的类型较宽松
   - PostgreSQL/MySQL 需要明确的类型

2. **SQL 语法差异**：
   - 应用已处理大部分差异
   - 如有问题，查看错误日志

3. **数据迁移**：
   - 如果不迁移数据，应用会自动创建新表
   - 旧数据保留在 SQLite 文件中

### Supabase 特别提示

1. **连接池模式**：
   - 必须使用端口 **6543**（连接池）
   - 不要使用 5432（直连，不支持连接池）

2. **免费额度**：
   - 数据库大小：500MB
   - 每月请求：50万次
   - 超出后需要付费

3. **密码安全**：
   - 不要在代码中硬编码密码
   - 使用环境变量或 `.env` 文件

---

## 🎯 推荐配置

### 开发环境

```env
# 可以继续使用 SQLite
# DATABASE_URL=sqlite:///gongkao_test.db

# 或者本地 PostgreSQL
DATABASE_URL=postgresql://postgres:password@localhost:5432/gongkao_dev
```

### 生产环境

```env
# Supabase PostgreSQL（推荐）
DATABASE_URL=postgresql://postgres:password@db.xxxxx.supabase.co:6543/postgres

# 或自己的 PostgreSQL 服务器
DATABASE_URL=postgresql://user:password@your-server.com:5432/gongkao_prod
```

---

## 📄 相关文档

- `数据库连接池优化说明.md` - 连接池优化详情
- `连接池优化完成.md` - 优化完成说明
- `env.example` - 环境变量配置示例

---

## ❓ 常见问题

### Q1: 切换数据库需要重新创建表吗？

**A**: 不需要。应用会在启动时自动创建表结构（如果不存在）。

### Q2: 如何迁移 SQLite 数据到 PostgreSQL？

**A**: 可以编写迁移脚本，或者先在新数据库中创建表，然后手动导入数据。

### Q3: 切换后性能会提升多少？

**A**: 
- 并发写入：SQLite 锁库 → PostgreSQL/MySQL 无锁
- 查询速度：类似
- 连接池：已优化，支持 50 并发连接

### Q4: Supabase 免费额度够用吗？

**A**: 对于中小规模应用通常足够。如果超出，可以考虑：
- 优化查询
- 使用缓存
- 升级到付费计划

---

## ✅ 总结建议

### 如果遇到连接池问题：

1. **先尝试优化后的 SQLite**（连接池已优化到 20/30）
2. **如果仍然有问题** → 切换到 PostgreSQL/MySQL
3. **生产环境** → 推荐 Supabase PostgreSQL

### 立即切换的场景：

- ✅ 生产环境部署
- ✅ 高并发批量处理（并发数 > 20）
- ✅ 频繁写入操作

### 可以继续使用 SQLite：

- ✅ 开发/测试环境
- ✅ 并发量较小（< 20）
- ✅ 主要是读取操作
