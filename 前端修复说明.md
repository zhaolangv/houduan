# å‰ç«¯å¼‚æ­¥æ¥å£ä¿®å¤è¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

åç«¯å·²æˆåŠŸè¿”å›å®Œæ•´æ•°æ®ï¼Œä½†å‰ç«¯åœ¨è§£æä»»åŠ¡ç»“æœæ—¶å‡ºç°é”™è¯¯ï¼š
```
âŒ é¢˜ç›® #1 å¤„ç†å¤±è´¥: [-1] æœªçŸ¥é”™è¯¯
```

**åŸå› åˆ†æ**ï¼šå‰ç«¯ JSON è§£ææ—¶æ²¡æœ‰æ­£ç¡®å¤„ç†å¯ç©ºå­—æ®µå’Œå­—æ®µåæ˜ å°„ã€‚

---

## ğŸ”§ éœ€è¦ä¿®å¤çš„é—®é¢˜

### 1. **Kotlin æ•°æ®ç±»å­—æ®µå¯ç©ºæ€§**

åç«¯è¿”å›çš„ JSON ä¸­ï¼ŒæŸäº›å­—æ®µå¯èƒ½ä¸º `null`ï¼ˆç‰¹åˆ«æ˜¯ `preliminary_answer`ï¼‰ï¼Œä½†å‰ç«¯æ•°æ®ç±»å¯èƒ½å®šä¹‰ä¸ºéç©ºï¼Œå¯¼è‡´è§£æå¤±è´¥ã€‚

**éœ€è¦æ£€æŸ¥çš„æ•°æ®ç±»**ï¼š
- `QuestionResult` / `QuestionItem` / `BatchQuestionResult`
- ç¡®ä¿æ‰€æœ‰å¯èƒ½ä¸º `null` çš„å­—æ®µéƒ½å£°æ˜ä¸ºå¯ç©ºç±»å‹

### 2. **å­—æ®µåæ˜ å°„é—®é¢˜**

åç«¯è¿”å›çš„å­—æ®µåæ˜¯ **snake_case**ï¼ˆå¦‚ `question_text`ï¼‰ï¼Œä½† Kotlin é€šå¸¸ä½¿ç”¨ **camelCase**ï¼ˆå¦‚ `questionText`ï¼‰ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `@SerializedName` æ³¨è§£è¿›è¡Œå­—æ®µæ˜ å°„ã€‚

### 3. **å®Œæ•´çš„æ•°æ®ç±»å®šä¹‰**

ç¡®ä¿æ•°æ®ç±»åŒ…å«æ‰€æœ‰åç«¯è¿”å›çš„å­—æ®µï¼ŒåŒ…æ‹¬å¯é€‰çš„å­—æ®µã€‚

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤åçš„æ•°æ®ç±»å®šä¹‰

```kotlin
import com.google.gson.annotations.SerializedName

// å•é“é¢˜çš„ç»“æœ
data class QuestionResult(
    @SerializedName("success")
    val success: Boolean,
    
    @SerializedName("question_text")
    val questionText: String? = null,  // âš ï¸ å¯ç©ºï¼Œå¯èƒ½ä¸º null
    
    @SerializedName("options")
    val options: List<String>? = null,  // âš ï¸ å¯ç©ºï¼Œå¯èƒ½ä¸ºç©ºåˆ—è¡¨æˆ– null
    
    @SerializedName("question_type")
    val questionType: String? = null,  // âš ï¸ å¯ç©º
    
    @SerializedName("preliminary_answer")
    val preliminaryAnswer: String? = null,  // âš ï¸ å¯ç©ºï¼ŒOCR æ— æ³•è¯†åˆ«é€‰é¡¹æ—¶å¯èƒ½ä¸º null
    
    @SerializedName("answer_reason")
    val answerReason: String? = null,  // âš ï¸ å¯ç©º
    
    @SerializedName("raw_text")
    val rawText: String? = null,  // âš ï¸ OCR åŸå§‹æ–‡æœ¬ï¼Œå¯ç©º
    
    @SerializedName("ocr_time")
    val ocrTime: Double = 0.0,
    
    @SerializedName("ai_time")
    val aiTime: Double = 0.0,
    
    @SerializedName("total_time")
    val totalTime: Double = 0.0,
    
    @SerializedName("cost")
    val cost: Double = 0.0,
    
    @SerializedName("input_tokens")
    val inputTokens: Int = 0,
    
    @SerializedName("output_tokens")
    val outputTokens: Int = 0,
    
    @SerializedName("total_tokens")
    val totalTokens: Int = 0,
    
    @SerializedName("error")
    val error: String? = null  // âš ï¸ é”™è¯¯ä¿¡æ¯ï¼ˆå¤„ç†å¤±è´¥æ—¶æ‰æœ‰ï¼‰
)

// æ‰¹é‡å¤„ç†ç»“æœ
data class BatchResult(
    @SerializedName("results")
    val results: List<QuestionResult>,
    
    @SerializedName("total")
    val total: Int,
    
    @SerializedName("success_count")
    val successCount: Int,
    
    @SerializedName("failed_count")
    val failedCount: Int,
    
    @SerializedName("total_time")
    val totalTime: Double,
    
    @SerializedName("avg_time_per_question")
    val avgTimePerQuestion: Double,
    
    @SerializedName("total_cost")
    val totalCost: Double,
    
    // å…¼å®¹å­—æ®µï¼ˆæ–‡æ¡£ä¸­æåˆ°äº† statisticsï¼‰
    @SerializedName("statistics")
    val statistics: Statistics? = null
)

data class Statistics(
    @SerializedName("total")
    val total: Int,
    
    @SerializedName("success_count")
    val successCount: Int,
    
    @SerializedName("failed_count")
    val failedCount: Int,
    
    @SerializedName("total_time")
    val totalTime: Double,
    
    @SerializedName("avg_time_per_question")
    val avgTimePerQuestion: Double,
    
    @SerializedName("total_cost")
    val totalCost: Double
)

// ä»»åŠ¡ç»“æœå“åº”
data class TaskResultResponse(
    @SerializedName("success")
    val success: Boolean,
    
    @SerializedName("status")
    val status: String,  // "completed" | "failed" | "processing"
    
    @SerializedName("result")
    val result: BatchResult? = null,  // âš ï¸ å¯ç©ºï¼Œä»»åŠ¡å®Œæˆæ—¶æ‰æœ‰
    
    @SerializedName("error")
    val error: String? = null,  // âš ï¸ å¯ç©ºï¼Œä»»åŠ¡å¤±è´¥æ—¶æ‰æœ‰
    
    @SerializedName("message")
    val message: String? = null  // âš ï¸ å¯ç©ºï¼Œä»»åŠ¡è¿›è¡Œä¸­æ—¶æ‰æœ‰
)
```

---

## ğŸ” å…³é”®ä¿®å¤ç‚¹

### 1. **æ‰€æœ‰å¯èƒ½ä¸º null çš„å­—æ®µå¿…é¡»å£°æ˜ä¸ºå¯ç©ºç±»å‹**

```kotlin
// âŒ é”™è¯¯ï¼šéç©ºç±»å‹ï¼Œè§£æ null æ—¶ä¼šå´©æºƒ
val questionText: String

// âœ… æ­£ç¡®ï¼šå¯ç©ºç±»å‹ï¼Œä½¿ç”¨é»˜è®¤å€¼
val questionText: String? = null
```

### 2. **ä½¿ç”¨ @SerializedName æ³¨è§£æ˜ å°„å­—æ®µå**

```kotlin
// âŒ é”™è¯¯ï¼šå­—æ®µåä¸åŒ¹é…ï¼Œæ— æ³•è§£æ
val questionText: String?

// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ³¨è§£æ˜ å°„
@SerializedName("question_text")
val questionText: String?
```

### 3. **å¤„ç†ç»“æœæ—¶æ£€æŸ¥ success å­—æ®µ**

```kotlin
fun processResults(results: List<QuestionResult>) {
    results.forEachIndexed { index, item ->
        if (item.success) {
            // å¤„ç†æˆåŠŸçš„ç»“æœ
            val questionText = item.questionText ?: "æœªè¯†åˆ«åˆ°é¢˜ç›®"
            val options = item.options ?: emptyList()
            val answer = item.preliminaryAnswer ?: "æœªæä¾›"
            
            // æ˜¾ç¤ºé¢˜ç›®å†…å®¹
            displayQuestion(index + 1, questionText, options, answer)
        } else {
            // å¤„ç†å¤±è´¥çš„ç»“æœ
            val errorMsg = item.error ?: "æœªçŸ¥é”™è¯¯"
            showError("é¢˜ç›® #${index + 1} å¤„ç†å¤±è´¥: $errorMsg")
        }
    }
}
```

### 4. **å®‰å…¨çš„ç©ºå€¼å¤„ç†**

```kotlin
// å®‰å…¨çš„é€‰é¡¹å¤„ç†
val options = questionResult.options?.takeIf { it.isNotEmpty() } 
    ?: listOf("A. (æœªè¯†åˆ«)", "B. (æœªè¯†åˆ«)", "C. (æœªè¯†åˆ«)", "D. (æœªè¯†åˆ«)")

// å®‰å…¨çš„ç­”æ¡ˆå¤„ç†
val answer = questionResult.preliminaryAnswer?.takeIf { it.isNotBlank() } 
    ?: "æœªæä¾›"
```

---

## ğŸ“ åç«¯è¿”å›çš„æ•°æ®æ ¼å¼

### æˆåŠŸå“åº”ç¤ºä¾‹

```json
{
  "success": true,
  "status": "completed",
  "result": {
    "results": [
      {
        "success": true,
        "question_text": "é¢˜ç›®å†…å®¹...",
        "options": ["A. é€‰é¡¹A", "B. é€‰é¡¹B", "C. é€‰é¡¹C", "D. é€‰é¡¹D"],
        "question_type": "è¡Œæµ‹-è¨€è¯­ç†è§£",
        "preliminary_answer": "B",  // âš ï¸ å¯èƒ½ä¸º null
        "answer_reason": "ç†ç”±è¯´æ˜...",  // âš ï¸ å¯èƒ½ä¸º null
        "raw_text": "OCRåŸå§‹æ–‡æœ¬...",
        "ocr_time": 129.08,
        "ai_time": 12.99,
        "total_time": 143.26,
        "cost": 0.000229,
        "input_tokens": 393,
        "output_tokens": 311,
        "total_tokens": 704
      },
      {
        "success": true,
        "question_text": "é¢˜ç›®å†…å®¹...",
        "options": ["A. é€‰é¡¹A", "B. é€‰é¡¹B", "C. é€‰é¡¹C", "D. é€‰é¡¹D"],
        "question_type": "è¡Œæµ‹-è¨€è¯­ç†è§£",
        "preliminary_answer": null,  // âš ï¸ OCR æ— æ³•è¯†åˆ«é€‰é¡¹æ—¶ä¸º null
        "answer_reason": null,  // âš ï¸ æ²¡æœ‰åˆæ­¥ç­”æ¡ˆæ—¶ä¸º null
        "raw_text": "OCRåŸå§‹æ–‡æœ¬...",
        "ocr_time": 148.74,
        "ai_time": 7.65,
        "total_time": 157.54,
        "cost": 0.000130,
        "input_tokens": 309,
        "output_tokens": 156,
        "total_tokens": 465
      }
    ],
    "total": 4,
    "success_count": 4,
    "failed_count": 0,
    "total_time": 208.15,
    "avg_time_per_question": 172.01,
    "total_cost": 0.000723,
    "statistics": {
      "total": 4,
      "success_count": 4,
      "failed_count": 0,
      "total_time": 208.15,
      "avg_time_per_question": 172.01,
      "total_cost": 0.000723
    }
  }
}
```

### å¤±è´¥å“åº”ç¤ºä¾‹

```json
{
  "success": false,
  "status": "failed",
  "error": "é”™è¯¯ä¿¡æ¯æè¿°"
}
```

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. **æµ‹è¯•ç©ºå€¼å¤„ç†**

ç¡®ä¿ä»¥ä¸‹æƒ…å†µä¸ä¼šå´©æºƒï¼š
- `preliminary_answer` ä¸º `null`
- `options` ä¸ºç©ºåˆ—è¡¨æˆ– `null`
- `question_text` ä¸º `null` æˆ–ç©ºå­—ç¬¦ä¸²

### 2. **æµ‹è¯•å­—æ®µæ˜ å°„**

éªŒè¯æ‰€æœ‰å­—æ®µéƒ½èƒ½æ­£ç¡®è§£æï¼š
```kotlin
val result = gson.fromJson(jsonString, TaskResultResponse::class.java)
println("Success: ${result.success}")
println("Status: ${result.status}")
println("Results count: ${result.result?.results?.size ?: 0}")
```

### 3. **æµ‹è¯•é”™è¯¯å¤„ç†**

ç¡®ä¿å¤±è´¥çš„ä»»åŠ¡èƒ½æ­£ç¡®æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼š
```kotlin
if (!result.success) {
    val errorMsg = result.error ?: "æœªçŸ¥é”™è¯¯"
    showError(errorMsg)
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Gson é…ç½®**ï¼šç¡®ä¿ Gson é…ç½®æ”¯æŒç©ºå€¼å¤„ç†
   ```kotlin
   val gson = GsonBuilder()
       .serializeNulls()  // å…è®¸åºåˆ—åŒ– null å€¼
       .create()
   ```

2. **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨ Kotlin çš„å¯ç©ºç±»å‹ç³»ç»Ÿï¼Œé¿å…ç©ºæŒ‡é’ˆå¼‚å¸¸

3. **é”™è¯¯æ—¥å¿—**ï¼šåœ¨è§£æå¤±è´¥æ—¶è®°å½•å®Œæ•´çš„ JSON å“åº”ï¼Œä¾¿äºè°ƒè¯•

4. **å‘åå…¼å®¹**ï¼šå¦‚æœä¹‹å‰æœ‰æ—§çš„æ•°æ®ç±»ï¼Œè€ƒè™‘ä½¿ç”¨ `@SerializedName` ä¿æŒå…¼å®¹

---

## ğŸ“ å¦‚æœ‰é—®é¢˜

å¦‚æœåœ¨ä¿®å¤è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ï¼š
1. æ£€æŸ¥åç«¯æ—¥å¿—ä¸­çš„è¿”å›æ•°æ®ç»“æ„
2. å¯¹æ¯”å®é™…çš„ JSON å“åº”ä¸æ•°æ®ç±»å®šä¹‰
3. ä½¿ç”¨ Gson çš„ `fromJson()` æ—¶æ·»åŠ é”™è¯¯å¤„ç†

---

**ä¿®å¤å®Œæˆåï¼Œæ‰€æœ‰é¢˜ç›®æ•°æ®åº”è¯¥èƒ½æ­£å¸¸æ˜¾ç¤ºåœ¨å‰ç«¯ç•Œé¢ã€‚**
