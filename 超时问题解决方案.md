# HTTP 524 超时错误解决方案

## 🔍 问题分析

**错误代码**: HTTP 524 (A Timeout Occurred)

**原因**:
- Cloudflare/ngrok 的默认超时时间约为 **100-120 秒**
- 后端批量处理耗时超过了这个限制
- 即使优化后，如果处理时间仍然超过 2 分钟，就会超时

## 📊 当前处理时间分析

根据日志，请求处理时间：
- 单张图片：约 3-5 秒（优化后）
- 5张图片并发：约 15-25 秒（理想情况）
- **但实际可能需要更长时间**（AI API 响应慢、网络延迟等）

## 🚀 解决方案

### 方案1: 异步处理（推荐）⭐ **已实现**

**原理**：
- 立即返回任务ID（响应时间 < 1 秒）
- 后端在后台处理
- 客户端轮询查询处理状态

**优点**：
- ✅ 不会超时（立即返回任务ID）
- ✅ 用户体验好（可以显示进度）
- ✅ 支持大量图片
- ✅ 可以显示处理进度

**接口说明**：

#### 1. 提交异步任务
```
POST /api/questions/extract/batch/async
Content-Type: application/json

请求体：与同步接口相同
{
  "images": [...],
  "max_workers": 10
}

返回：
{
  "success": true,
  "task_id": "任务ID",
  "status_url": "/api/tasks/{task_id}/status",
  "result_url": "/api/tasks/{task_id}/result"
}
```

#### 2. 查询任务状态
```
GET /api/tasks/{task_id}/status

返回：
{
  "success": true,
  "task": {
    "id": "任务ID",
    "status": "pending|processing|completed|failed",
    "progress": {
      "total": 10,
      "completed": 5,
      "failed": 0
    },
    "total_time": 123.5
  }
}
```

#### 3. 获取任务结果
```
GET /api/tasks/{task_id}/result

返回（任务完成时）：
{
  "success": true,
  "status": "completed",
  "result": {
    "results": [...],
    "statistics": {...}
  }
}
```

**客户端实现示例**：
```kotlin
// 1. 提交异步任务
val submitResponse = apiClient.submitBatchAsync(images)
val taskId = submitResponse.task_id

// 2. 轮询查询状态（每2秒查询一次）
while (true) {
    val status = apiClient.getTaskStatus(taskId)
    
    when (status.task.status) {
        "completed" -> {
            // 3. 获取结果
            val result = apiClient.getTaskResult(taskId)
            // 处理结果
            break
        }
        "failed" -> {
            // 处理失败
            break
        }
        "processing", "pending" -> {
            // 显示进度
            showProgress(status.task.progress)
            Thread.sleep(2000)  // 等待2秒后继续查询
        }
    }
}
```

### 方案2: 增加超时时间

**对于 ngrok**：
- 免费版可能不支持自定义超时
- 付费版可以增加超时时间

**对于 Cloudflare**：
- 可以通过 Cloudflare Workers 或 Page Rules 增加超时
- 但免费版有限制

### 方案3: 分批处理（客户端）

**客户端优化**：
- 如果图片数量多（>10张），分批发送
- 每批 5-10 张图片
- 分别处理每批，避免单次请求超时

### 方案4: 优化性能（已做，继续优化）

**已完成**：
- ✅ 移除 OCR 线程锁（并发处理）
- ✅ 优化重复检测（数据库为空时跳过）
- ✅ 跳过图片预处理（批量处理时）

**可继续优化**：
- 使用 GPU 加速 OCR（如果可用）
- 优化 AI API 调用（批量请求）
- 减少网络延迟

## ⚡ 快速修复（临时方案）

### 临时方案1: 减少并发数

在客户端减少并发数，降低单次请求压力：

```json
{
  "images": [...],
  "max_workers": 5  // 从 10 减少到 5
}
```

### 临时方案2: 分批发送

客户端将大批量分成小批量发送：

```kotlin
// 如果图片数量 > 5，分批发送
if (images.size > 5) {
    val batches = images.chunked(5)
    for (batch in batches) {
        sendBatch(batch)  // 每批5张
    }
}
```

### 临时方案3: 使用前端 OCR

如果前端已提供 OCR 结果，直接使用，跳过后端 OCR：

```json
{
  "images": [
    {
      "data": "base64...",
      "filename": "xxx.jpg",
      "ocr_text": "前端OCR结果"  // 提供这个可以跳过OCR
    }
  ]
}
```

## 📝 推荐实施方案

### 短期（立即实施）

1. ✅ **客户端分批处理**：将 >5 张图片分成多批
2. ✅ **减少并发数**：从 10 减少到 5
3. ✅ **使用前端 OCR**：如果前端已提供 OCR 结果

### 中期（已实现）✅

1. **异步处理接口**（已完成）：
   - ✅ `POST /api/questions/extract/batch/async` - 提交任务，返回任务ID
   - ✅ `GET /api/tasks/{task_id}/status` - 查询任务状态
   - ✅ `GET /api/tasks/{task_id}/result` - 获取处理结果

2. **进度查询**（已完成）：
   - ✅ 客户端轮询状态接口即可获取进度
   - ⚠️ WebSocket 推送（可选，未来可添加）

### 长期（性能优化）

1. **GPU 加速 OCR**（如果服务器有 GPU）
2. **AI API 批量调用**（如果 API 支持）
3. **缓存机制**（避免重复处理）

## 🔧 客户端代码示例

### 分批处理示例

```kotlin
fun sendBatches(images: List<ImageData>) {
    val batchSize = 5
    val batches = images.chunked(batchSize)
    
    batches.forEachIndexed { index, batch ->
        logger.info("发送批次 ${index + 1}/${batches.size}, 包含 ${batch.size} 张图片")
        
        try {
            val result = sendBatchRequest(batch)
            // 处理结果
        } catch (e: SocketTimeoutException) {
            logger.error("批次 ${index + 1} 超时，尝试重试...")
            // 重试逻辑
        }
    }
}
```

### 减少并发数

```kotlin
val request = BatchQuestionRequest(
    images = imageList,
    max_workers = 5  // 从 10 减少到 5
)
```

## 📋 检查清单

### 立即实施（推荐）

- [x] ✅ **异步处理接口已实现** - 使用 `/api/questions/extract/batch/async`
- [ ] 客户端切换到异步接口
- [ ] 客户端实现轮询逻辑

### 备选方案（如果不想用异步）

- [ ] 客户端已实现分批处理（每批 ≤5 张）
- [ ] 并发数已降低到 5
- [ ] 前端提供 OCR 结果（如果可能）
- [ ] 客户端超时时间 ≥ 300 秒（5分钟）

## ⚠️ 注意事项

1. **Cloudflare/ngrok 超时**：
   - 免费版通常限制在 100-120 秒
   - **使用异步接口可以完全避免超时问题**（立即返回任务ID）

2. **异步处理优势**：
   - ✅ 立即返回，不会超时
   - ✅ 可以显示处理进度
   - ✅ 支持大量图片处理
   - ✅ 用户体验更好

3. **轮询频率建议**：
   - 任务状态查询：每 2-3 秒查询一次
   - 任务完成后立即获取结果

4. **任务保留时间**：
   - 任务结果保留 2 小时
   - 完成后及时获取结果
