# éªŒè¯ç”¨æˆ·æ•°æ®æ˜¯å¦å†™å…¥æ•°æ®åº“

## ğŸ“Š æ ¹æ®ä½ çš„æ—¥å¿—åˆ†æ

ä»ä½ çš„æ—¥å¿—æ¥çœ‹ï¼š
```
[2025-12-09 10:20:49] [DEBUG] [__main__] [API] ğŸ“Š ç”¨æˆ·æ´»åŠ¨å·²è®°å½•: 1de5017b1bff75dd
```

**è¿™è¯´æ˜**ï¼š
1. âœ… ä»£ç æ‰§è¡Œåˆ°äº†è®°å½•ç”¨æˆ·æ´»åŠ¨çš„æ­¥éª¤
2. âœ… è®¾å¤‡IDå·²è·å–ï¼š`1de5017b1bff75dd`
3. âš ï¸ ä½†æ—¥å¿—çº§åˆ«æ˜¯ `DEBUG`ï¼Œå¯èƒ½çœ‹ä¸åˆ°æ•°æ®åº“å†™å…¥çš„è¯¦ç»†æ—¥å¿—

---

## ğŸ” éªŒè¯æ–¹æ³•

### æ–¹æ³•1: ä½¿ç”¨APIæŸ¥è¯¢ï¼ˆæ¨èï¼‰

è°ƒç”¨ç”¨æˆ·ç»Ÿè®¡APIæ¥éªŒè¯ï¼š

```bash
# æŸ¥çœ‹ç”¨æˆ·ç»Ÿè®¡
curl http://localhost:5000/api/users/stats

# æŸ¥çœ‹ç‰¹å®šè®¾å¤‡IDçš„ç•™å­˜ç‡
curl http://localhost:5000/api/users/retention?days=7
```

**é¢„æœŸç»“æœ**ï¼š
- å¦‚æœæ•°æ®å·²å†™å…¥ï¼Œä¼šçœ‹åˆ° `total_users >= 1`
- ä¼šæ˜¾ç¤ºæ´»è·ƒç”¨æˆ·æ•°

### æ–¹æ³•2: ç›´æ¥æŸ¥è¯¢æ•°æ®åº“

å¦‚æœä½ æœ‰æ•°æ®åº“è®¿é—®æƒé™ï¼š

```sql
-- æŸ¥çœ‹ç”¨æˆ·ä¼šè¯è¡¨
SELECT * FROM user_sessions WHERE device_id = '1de5017b1bff75dd';

-- æŸ¥çœ‹ä»Šæ—¥æ´»è·ƒç”¨æˆ·
SELECT * FROM daily_active_users WHERE date = CURRENT_DATE;

-- ç»Ÿè®¡æ€»ç”¨æˆ·æ•°
SELECT COUNT(*) FROM user_sessions;
```

### æ–¹æ³•3: æŸ¥çœ‹æ›´è¯¦ç»†çš„æ—¥å¿—

æˆ‘å·²ç»æ›´æ–°äº†ä»£ç ï¼Œå°†æ—¥å¿—çº§åˆ«ä» `DEBUG` æ”¹ä¸º `INFO`ï¼Œç°åœ¨ä¼šæ˜¾ç¤ºæ›´è¯¦ç»†çš„ä¿¡æ¯ï¼š

**æ›´æ–°åçš„æ—¥å¿—ä¼šæ˜¾ç¤º**ï¼š
```
[INFO] [UserStats] âœ… ç”¨æˆ·æ´»åŠ¨å·²è®°å½•åˆ°æ•°æ®åº“: 1de5017b1bff75dd, é¢˜ç›®æ•°: 0, æ—¥æœŸ: 2025-12-09
```

**å¦‚æœå†™å…¥å¤±è´¥ï¼Œä¼šæ˜¾ç¤º**ï¼š
```
[ERROR] [UserStats] âŒ è®°å½•ç”¨æˆ·æ´»åŠ¨å¤±è´¥: [é”™è¯¯ä¿¡æ¯]
```

---

## âœ… ä»£ç é€»è¾‘ç¡®è®¤

ä» `user_statistics_service.py` çš„ä»£ç æ¥çœ‹ï¼š

```python
def track_user_activity(self, device_id, device_info=None, app_version=None, question_count=0):
    try:
        # ... åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·ä¼šè¯ ...
        # ... åˆ›å»ºæˆ–æ›´æ–°æ¯æ—¥æ´»è·ƒè®°å½• ...
        
        db.session.commit()  # â† è¿™é‡Œä¼šæäº¤åˆ°æ•°æ®åº“
        logger.info(f"[UserStats] âœ… ç”¨æˆ·æ´»åŠ¨å·²è®°å½•åˆ°æ•°æ®åº“: ...")
        
    except Exception as e:
        db.session.rollback()  # â† å¦‚æœå¤±è´¥ä¼šå›æ»š
        logger.error(f"[UserStats] âŒ è®°å½•ç”¨æˆ·æ´»åŠ¨å¤±è´¥: {e}")
```

**å…³é”®ç‚¹**ï¼š
- âœ… æœ‰ `db.session.commit()` - ä¼šå†™å…¥æ•°æ®åº“
- âœ… æœ‰å¼‚å¸¸å¤„ç† - å¦‚æœå¤±è´¥ä¼šè®°å½•é”™è¯¯
- âœ… æœ‰å›æ»šæœºåˆ¶ - ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. é‡æ–°å‘é€è¯·æ±‚

```bash
# å‘é€ç‰ˆæœ¬æ£€æŸ¥è¯·æ±‚ï¼ˆä¼šè‡ªåŠ¨è®°å½•ç”¨æˆ·æ´»åŠ¨ï¼‰
curl -H "X-Device-ID: test-device-123" \
     -H "X-App-Version: 2.0" \
     "http://localhost:5000/api/version?client_version=2.0"
```

### 2. æŸ¥çœ‹æ—¥å¿—

ç°åœ¨åº”è¯¥èƒ½çœ‹åˆ°æ›´è¯¦ç»†çš„æ—¥å¿—ï¼š
- âœ… æˆåŠŸï¼š`[INFO] [UserStats] âœ… ç”¨æˆ·æ´»åŠ¨å·²è®°å½•åˆ°æ•°æ®åº“: ...`
- âŒ å¤±è´¥ï¼š`[ERROR] [UserStats] âŒ è®°å½•ç”¨æˆ·æ´»åŠ¨å¤±è´¥: ...`

### 3. æŸ¥è¯¢APIéªŒè¯

```bash
curl http://localhost:5000/api/users/stats
```

**å¦‚æœæ•°æ®å·²å†™å…¥ï¼Œä¼šè¿”å›**ï¼š
```json
{
  "success": true,
  "data": {
    "total_users": 1,  // â† åº”è¯¥ >= 1
    "active_users": 1,
    "new_users": 1,
    ...
  }
}
```

---

## ğŸ¯ ç»“è®º

**æ ¹æ®ä»£ç é€»è¾‘ï¼Œæ•°æ®åº”è¯¥å·²ç»å†™å…¥æ•°æ®åº“äº†**ï¼Œå› ä¸ºï¼š
1. âœ… ä»£ç æ‰§è¡Œåˆ°äº† `logger.debug(f"[API] ğŸ“Š ç”¨æˆ·æ´»åŠ¨å·²è®°å½•: {device_id}")` è¿™ä¸€è¡Œ
2. âœ… `track_user_activity` æ–¹æ³•ä¸­æœ‰ `db.session.commit()`
3. âœ… æ²¡æœ‰çœ‹åˆ°é”™è¯¯æ—¥å¿—ï¼ˆå¦‚æœæœ‰é”™è¯¯ä¼šæ˜¾ç¤º `[ERROR]`ï¼‰

**å»ºè®®**ï¼š
1. ä½¿ç”¨APIæŸ¥è¯¢éªŒè¯ï¼š`curl http://localhost:5000/api/users/stats`
2. é‡æ–°å‘é€ä¸€æ¬¡è¯·æ±‚ï¼ŒæŸ¥çœ‹æ›´æ–°åçš„è¯¦ç»†æ—¥å¿—
3. å¦‚æœä»ç„¶ä¸ç¡®å®šï¼Œå¯ä»¥ç›´æ¥æŸ¥è¯¢æ•°æ®åº“

---

## ğŸ“ å¿«é€ŸéªŒè¯å‘½ä»¤

```bash
# 1. å‘é€è¯·æ±‚ï¼ˆä¼šè®°å½•ç”¨æˆ·æ´»åŠ¨ï¼‰
curl -H "X-Device-ID: test-$(date +%s)" \
     -H "X-App-Version: 2.0" \
     "http://localhost:5000/api/version?client_version=2.0"

# 2. ç«‹å³æŸ¥è¯¢ç»Ÿè®¡ï¼ˆéªŒè¯æ•°æ®æ˜¯å¦å†™å…¥ï¼‰
curl http://localhost:5000/api/users/stats
```

å¦‚æœ `total_users` å¢åŠ äº†ï¼Œè¯´æ˜æ•°æ®å·²æˆåŠŸå†™å…¥ï¼âœ…
