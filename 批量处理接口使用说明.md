# æ‰¹é‡å¤„ç†æ¥å£ä½¿ç”¨è¯´æ˜

## âœ… å·²å®Œæˆçš„å·¥ä½œ

å·²æˆåŠŸå°†å¹¶å‘å¤„ç†æ–¹æ¡ˆé›†æˆåˆ°ç°æœ‰APIæ¥å£ä¸­ï¼Œæ–°å¢äº†**å¿«é€Ÿæ‰¹é‡æå–æ¥å£**ï¼š

### æ–°å¢æ¥å£

**`POST /api/questions/extract/batch`**

- âœ… ä½¿ç”¨**æœ¬åœ°OCR**ï¼ˆå…è´¹ã€å¿«é€Ÿï¼‰
- âœ… ä½¿ç”¨**DeepSeek**æå–ï¼ˆè´¹ç”¨æœ€ä½ Â¥0.000117/æ¬¡ï¼Œå‡†ç¡®ç‡1.00ï¼‰
- âœ… **é«˜å¹¶å‘å¤„ç†**ï¼ˆé»˜è®¤10ä¸ªå¹¶å‘ï¼Œ50é¢˜çº¦2-3åˆ†é’Ÿï¼‰
- âœ… æ¯é“é¢˜ç‹¬ç«‹è¯·æ±‚ï¼ˆé”™è¯¯éš”ç¦»å¥½ï¼‰

---

## ğŸ“ æ¥å£æ–‡æ¡£

### è¯·æ±‚æ ¼å¼

#### æ–¹å¼1ï¼šmultipart/form-dataï¼ˆæ¨èç”¨äºæ–‡ä»¶ä¸Šä¼ ï¼‰

```
POST /api/questions/extract/batch
Content-Type: multipart/form-data

images[]: å›¾ç‰‡æ–‡ä»¶1
images[]: å›¾ç‰‡æ–‡ä»¶2
...
images[]: å›¾ç‰‡æ–‡ä»¶50
max_workers: 10  (å¯é€‰ï¼Œé»˜è®¤10ï¼Œå¹¶å‘æ•°ï¼ŒèŒƒå›´3-20)
```

#### æ–¹å¼2ï¼šapplication/jsonï¼ˆæ¨èç”¨äºbase64ç¼–ç ï¼‰

```json
POST /api/questions/extract/batch
Content-Type: application/json

{
  "images": [
    {
      "filename": "image1.jpg",
      "data": "base64ç¼–ç çš„å›¾ç‰‡æ•°æ®"
    },
    ...
  ],
  "max_workers": 10  // å¯é€‰ï¼Œé»˜è®¤10
}
```

### å“åº”æ ¼å¼

```json
{
  "success": true,
  "results": [
    {
      "success": true,
      "question_text": "å®Œæ•´çš„é¢˜å¹²å†…å®¹",
      "options": ["A. é€‰é¡¹A", "B. é€‰é¡¹B", "C. é€‰é¡¹C", "D. é€‰é¡¹D"],
      "raw_text": "OCRåŸå§‹æ–‡æœ¬",
      "ocr_time": 6.5,
      "ai_time": 7.2,
      "total_time": 13.7,
      "input_tokens": 345,
      "output_tokens": 197,
      "total_tokens": 542,
      "cost": 0.000117
    },
    {
      "success": false,
      "error": "é”™è¯¯ä¿¡æ¯",
      "ocr_time": 0,
      "ai_time": 0,
      "total_time": 0
    }
  ],
  "statistics": {
    "total": 50,
    "success_count": 48,
    "failed_count": 2,
    "total_time": 150.5,
    "avg_time_per_question": 3.14,
    "total_cost": 0.005616
  }
}
```

---

## ğŸš€ å‰ç«¯è°ƒç”¨ç¤ºä¾‹

### JavaScriptç¤ºä¾‹

```javascript
// æ–¹å¼1ï¼šä¸Šä¼ æ–‡ä»¶ï¼ˆæ¨èï¼‰
async function extractBatchQuestions(imageFiles, maxWorkers = 10) {
  const formData = new FormData();
  
  // æ·»åŠ æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶
  imageFiles.forEach(file => {
    formData.append('images[]', file);
  });
  formData.append('max_workers', maxWorkers.toString());
  
  try {
    const response = await fetch('/api/questions/extract/batch', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
      console.log(`å¤„ç†å®Œæˆ: ${result.statistics.success_count}/${result.statistics.total}`);
      console.log(`æ€»è€—æ—¶: ${result.statistics.total_time.toFixed(1)}ç§’`);
      console.log(`æ€»è´¹ç”¨: Â¥${result.statistics.total_cost.toFixed(6)}`);
      
      // å¤„ç†ç»“æœ
      result.results.forEach((item, index) => {
        if (item.success) {
          console.log(`é¢˜ç›®${index+1}:`, item.question_text);
          console.log(`é€‰é¡¹:`, item.options);
        } else {
          console.error(`é¢˜ç›®${index+1}å¤±è´¥:`, item.error);
        }
      });
      
      return result;
    } else {
      console.error('æ‰¹é‡æå–å¤±è´¥:', result.error);
      return null;
    }
  } catch (error) {
    console.error('è¯·æ±‚å¤±è´¥:', error);
    return null;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const imageFiles = [...]; // å›¾ç‰‡æ–‡ä»¶åˆ—è¡¨
const result = await extractBatchQuestions(imageFiles, 10);
```

```javascript
// æ–¹å¼2ï¼šä½¿ç”¨base64
async function extractBatchQuestionsBase64(imagesBase64, maxWorkers = 10) {
  try {
    const response = await fetch('/api/questions/extract/batch', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        images: imagesBase64.map((base64, index) => ({
          filename: `image${index+1}.jpg`,
          data: base64
        })),
        max_workers: maxWorkers
      })
    });
    
    return await response.json();
  } catch (error) {
    console.error('è¯·æ±‚å¤±è´¥:', error);
    return null;
  }
}
```

### Reactç¤ºä¾‹

```jsx
import { useState } from 'react';

function BatchExtractComponent() {
  const [processing, setProcessing] = useState(false);
  const [results, setResults] = useState(null);
  const [progress, setProgress] = useState(0);
  
  const handleBatchExtract = async (imageFiles) => {
    setProcessing(true);
    setProgress(0);
    
    const formData = new FormData();
    imageFiles.forEach(file => {
      formData.append('images[]', file);
    });
    formData.append('max_workers', '10');
    
    try {
      const response = await fetch('/api/questions/extract/batch', {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      
      if (result.success) {
        setResults(result);
        setProgress(100);
      }
    } catch (error) {
      console.error('æ‰¹é‡æå–å¤±è´¥:', error);
    } finally {
      setProcessing(false);
    }
  };
  
  return (
    <div>
      <input
        type="file"
        multiple
        accept="image/*"
        onChange={(e) => {
          const files = Array.from(e.target.files);
          handleBatchExtract(files);
        }}
        disabled={processing}
      />
      
      {processing && (
        <div>
          <p>å¤„ç†ä¸­...</p>
          <progress value={progress} max={100} />
        </div>
      )}
      
      {results && (
        <div>
          <h3>å¤„ç†ç»“æœ</h3>
          <p>æˆåŠŸ: {results.statistics.success_count}/{results.statistics.total}</p>
          <p>æ€»è€—æ—¶: {results.statistics.total_time.toFixed(1)}ç§’</p>
          <p>æ€»è´¹ç”¨: Â¥{results.statistics.total_cost.toFixed(6)}</p>
          
          <ul>
            {results.results.map((item, index) => (
              <li key={index}>
                {item.success ? (
                  <div>
                    <p><strong>é¢˜ç›®{index+1}:</strong> {item.question_text}</p>
                    <p><strong>é€‰é¡¹:</strong> {item.options.join(', ')}</p>
                  </div>
                ) : (
                  <p style={{color: 'red'}}>é¢˜ç›®{index+1}å¤±è´¥: {item.error}</p>
                )}
              </li>
            ))}
          </ul>
        </div>
      )}
    </div>
  );
}
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡ï¼ˆ50é“é¢˜ï¼‰

| å¹¶å‘æ•° | å¤„ç†æ—¶é—´ | ç”¨æˆ·ä½“éªŒ | æ¨èåº¦ |
|--------|---------|---------|--------|
| ä¸²è¡Œ | ~20åˆ†é’Ÿ | âŒ å¤ªæ…¢ | âŒ |
| å¹¶å‘5 | ~4-5åˆ†é’Ÿ | âš ï¸ å¯æ¥å— | â­â­â­ |
| **å¹¶å‘10** | **~2-3åˆ†é’Ÿ** | âœ… **ä¼˜ç§€** | â­â­â­â­â­ |
| å¹¶å‘20 | ~1-2åˆ†é’Ÿ | âœ… æœ€å¿« | â­â­â­â­ |

**æ¨èé…ç½®**ï¼šé»˜è®¤å¹¶å‘10ï¼Œ50é¢˜çº¦2-3åˆ†é’Ÿ

---

## ğŸ’° è´¹ç”¨ä¼°ç®—

- **å•æ¬¡è´¹ç”¨**ï¼šÂ¥0.000117/æ¬¡
- **50é“é¢˜è´¹ç”¨**ï¼šÂ¥0.00585ï¼ˆçº¦6åˆ†é’±ï¼‰
- **100é“é¢˜è´¹ç”¨**ï¼šÂ¥0.0117ï¼ˆçº¦1æ¯›é’±ï¼‰
- **1000é“é¢˜è´¹ç”¨**ï¼šÂ¥0.117ï¼ˆçº¦1æ¯›2ï¼‰

**è´¹ç”¨æä½ï¼Œå¯ä»¥æ”¾å¿ƒä½¿ç”¨ï¼**

---

## ğŸ”§ é…ç½®è¯´æ˜

### å¹¶å‘æ•°é…ç½®

- **é»˜è®¤å€¼**ï¼š10ï¼ˆæ¨èï¼‰
- **æœ€å°å€¼**ï¼š3
- **æœ€å¤§å€¼**ï¼š20
- **æ¨èå€¼**ï¼š
  - 50é¢˜ä»¥å†…ï¼š10ä¸ªå¹¶å‘
  - 100é¢˜ä»¥ä¸Šï¼š15-20ä¸ªå¹¶å‘

### æ‰¹é‡å¤§å°é™åˆ¶

- **æœ€å¤§æ‰¹é‡**ï¼š100é¢˜/æ¬¡
- **æ¨èæ‰¹é‡**ï¼š50é¢˜/æ¬¡ï¼ˆå¹³è¡¡é€Ÿåº¦å’Œç¨³å®šæ€§ï¼‰

---

## ğŸ“¦ æ–‡ä»¶è¯´æ˜

### æ–°å¢æ–‡ä»¶

1. **`batch_question_service.py`**
   - æ‰¹é‡å¤„ç†æœåŠ¡æ ¸å¿ƒä»£ç 
   - åŒ…å«OCRå’ŒDeepSeekè°ƒç”¨é€»è¾‘
   - æ”¯æŒé«˜å¹¶å‘å¤„ç†

### ä¿®æ”¹æ–‡ä»¶

1. **`app.py`**
   - æ–°å¢ `/api/questions/extract/batch` æ¥å£
   - é›†æˆæ‰¹é‡å¤„ç†æœåŠ¡
   - æ›´æ–°æ¥å£åˆ—è¡¨

---

## âœ… æ¥å£å¯¹æ¯”

### ç°æœ‰æ¥å£ vs æ–°æ¥å£

| ç‰¹æ€§ | `/api/questions/analyze/batch` | `/api/questions/extract/batch` |
|------|-------------------------------|-------------------------------|
| OCRæ–¹å¼ | ç«å±±å¼•æ“ | æœ¬åœ°OCRï¼ˆå…è´¹ï¼‰ |
| AIæå– | ç«å±±å¼•æ“Vision | DeepSeekï¼ˆä¾¿å®œï¼‰ |
| å¹¶å‘æ•° | 3 | 10-20ï¼ˆå¯é…ç½®ï¼‰ |
| é€Ÿåº¦ | è¾ƒæ…¢ | å¿«ï¼ˆ2-3åˆ†é’Ÿ/50é¢˜ï¼‰ |
| è´¹ç”¨ | é«˜ | æä½ï¼ˆÂ¥0.000117/æ¬¡ï¼‰ |
| å‡†ç¡®ç‡ | ä¸­ç­‰ | é«˜ï¼ˆ1.00ï¼‰ |
| é€‚ç”¨åœºæ™¯ | éœ€è¦å­˜å…¥æ•°æ®åº“ | ä»…æå–å†…å®¹ |

**æ–°æ¥å£ä¸“é—¨ç”¨äºå¿«é€Ÿæ‰¹é‡æå–ï¼Œä¸å­˜å…¥æ•°æ®åº“ã€‚**

---

## ğŸ¯ ä½¿ç”¨å»ºè®®

1. **å¿«é€Ÿæå–**ï¼šä½¿ç”¨ `/api/questions/extract/batch`
   - ä¸éœ€è¦å­˜å…¥æ•°æ®åº“
   - åªéœ€è¦æå–é¢˜ç›®å’Œé€‰é¡¹
   - è¿½æ±‚é€Ÿåº¦å’Œæˆæœ¬

2. **å®Œæ•´åˆ†æ**ï¼šä½¿ç”¨ `/api/questions/analyze/batch`
   - éœ€è¦å­˜å…¥æ•°æ®åº“
   - éœ€è¦å»é‡æ£€æŸ¥
   - éœ€è¦å®Œæ•´çš„é¢˜ç›®ä¿¡æ¯

---

## ğŸ” æµ‹è¯•æ–¹æ³•

### ä½¿ç”¨curlæµ‹è¯•

```bash
# æµ‹è¯•å•å¼ å›¾ç‰‡
curl -X POST http://localhost:5000/api/questions/extract/batch \
  -F "images[]=@test1.jpg" \
  -F "max_workers=10"

# æµ‹è¯•å¤šå¼ å›¾ç‰‡
curl -X POST http://localhost:5000/api/questions/extract/batch \
  -F "images[]=@test1.jpg" \
  -F "images[]=@test2.jpg" \
  -F "images[]=@test3.jpg" \
  -F "max_workers=10"
```

### ä½¿ç”¨Pythonæµ‹è¯•

```python
import requests

# å‡†å¤‡å›¾ç‰‡æ–‡ä»¶
files = [
    ('images[]', open('test1.jpg', 'rb')),
    ('images[]', open('test2.jpg', 'rb')),
]

data = {
    'max_workers': 10
}

response = requests.post(
    'http://localhost:5000/api/questions/extract/batch',
    files=files,
    data=data
)

result = response.json()
print(f"æˆåŠŸ: {result['statistics']['success_count']}/{result['statistics']['total']}")
print(f"æ€»è€—æ—¶: {result['statistics']['total_time']:.1f}ç§’")
print(f"æ€»è´¹ç”¨: Â¥{result['statistics']['total_cost']:.6f}")
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **API Keyé…ç½®**ï¼šç¡®ä¿ `.env` æ–‡ä»¶ä¸­é…ç½®äº† `DEEPSEEK_API_KEY`
   ```
   DEEPSEEK_API_KEY=sk-7de12481a17045819fcf3a2838d884a1
   ```

2. **OCRä¾èµ–**ï¼šç¡®ä¿å·²å®‰è£… PaddleOCR
   ```bash
   pip install paddleocr
   ```

3. **å¹¶å‘é™åˆ¶**ï¼šæ ¹æ®æœåŠ¡å™¨æ€§èƒ½è°ƒæ•´å¹¶å‘æ•°ï¼Œä¸å»ºè®®è¶…è¿‡20

4. **è¶…æ—¶è®¾ç½®**ï¼šå»ºè®®å‰ç«¯è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º5-10åˆ†é’Ÿï¼ˆ50é¢˜ï¼‰

---

## ğŸ“ é—®é¢˜åé¦ˆ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨
2. OCRæœåŠ¡æ˜¯å¦å¯ç”¨
3. DeepSeek API Keyæ˜¯å¦æ­£ç¡®
4. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸

---

## ğŸ‰ æ€»ç»“

æ–°æ¥å£å·²æˆåŠŸé›†æˆï¼Œå¯ä»¥ï¼š
- âœ… å¿«é€Ÿæ‰¹é‡å¤„ç†50é“é¢˜ï¼ˆ2-3åˆ†é’Ÿï¼‰
- âœ… è´¹ç”¨æä½ï¼ˆçº¦6åˆ†é’±/50é¢˜ï¼‰
- âœ… å‡†ç¡®ç‡é«˜ï¼ˆ1.00ï¼‰
- âœ… å‰ç«¯å¯ç›´æ¥è°ƒç”¨

**ç«‹å³å¼€å§‹ä½¿ç”¨å§ï¼** ğŸš€
