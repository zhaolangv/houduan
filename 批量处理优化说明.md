# æ‰¹é‡å¤„ç†ä¼˜åŒ–è¯´æ˜

## å½“å‰å®ç°æ–¹å¼

**å½“å‰å®ç°ï¼šä¸€å¼ ä¸€å¼ å‘é€**

åœ¨æ‰¹é‡æ¥å£ `/api/questions/analyze/batch` ä¸­ï¼Œå¤„ç†æµç¨‹æ˜¯ï¼š

```python
for idx, q_data in enumerate(questions_data):
    # å¯¹æ¯å¼ å›¾ç‰‡å•ç‹¬è°ƒç”¨ analyze_question_from_image
    result = question_service.analyze_question_from_image(
        image_file=q_data['image_file'],
        ...
    )
```

è¿™æ„å‘³ç€ï¼š
- âœ… **ä¼˜ç‚¹**ï¼š
  1. **é”™è¯¯éš”ç¦»**ï¼šä¸€å¼ å›¾ç‰‡å¤±è´¥ä¸å½±å“å…¶ä»–å›¾ç‰‡
  2. **ç®€å•å¯é **ï¼šå¤ç”¨å•å¼ å›¾ç‰‡çš„å¤„ç†é€»è¾‘
  3. **æ˜“äºè°ƒè¯•**ï¼šæ¯å¼ å›¾ç‰‡çš„å¤„ç†è¿‡ç¨‹ç‹¬ç«‹
  4. **æ”¯æŒéƒ¨åˆ†æˆåŠŸ**ï¼šéƒ¨åˆ†å¤±è´¥ä¸å½±å“æ•´ä½“

- âš ï¸ **ç¼ºç‚¹**ï¼š
  1. **æ•ˆç‡è¾ƒä½**ï¼šéœ€è¦å¤šæ¬¡ç½‘ç»œè¯·æ±‚ï¼ˆå¦‚æœOCRæ˜¯è¿œç¨‹APIï¼‰
  2. **é€Ÿåº¦è¾ƒæ…¢**ï¼šé¡ºåºå¤„ç†ï¼Œæ— æ³•å¹¶è¡Œ
  3. **APIè°ƒç”¨æ¬¡æ•°å¤š**ï¼šå¯èƒ½è§¦å‘é™æµ

## ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå¹¶è¡Œå¤„ç†ï¼ˆæ¨èï¼‰âœ…

ä¿æŒä¸€å¼ ä¸€å¼ å‘é€ï¼Œä½†æ”¹ä¸º**å¹¶è¡Œå¤„ç†**ï¼š

```python
from concurrent.futures import ThreadPoolExecutor, as_completed

def process_single_question(q_data, idx):
    """å¤„ç†å•ä¸ªé¢˜ç›®"""
    try:
        result = question_service.analyze_question_from_image(...)
        return {'success': True, 'question': result, 'error': None, 'index': idx}
    except Exception as e:
        return {'success': False, 'question': None, 'error': {'code': 500, 'message': str(e)}, 'index': idx}

# å¹¶è¡Œå¤„ç†
with ThreadPoolExecutor(max_workers=5) as executor:
    futures = {executor.submit(process_single_question, q_data, idx): idx 
               for idx, q_data in enumerate(questions_data)}
    
    results = [None] * len(questions_data)
    for future in as_completed(futures):
        result = future.result()
        results[result['index']] = result
```

**ä¼˜ç‚¹**ï¼š
- æé«˜å¤„ç†é€Ÿåº¦ï¼ˆ5å€å·¦å³ï¼Œå–å†³äºå¹¶å‘æ•°ï¼‰
- ä¿æŒé”™è¯¯éš”ç¦»
- å®ç°ç®€å•

**ç¼ºç‚¹**ï¼š
- éœ€è¦æ§åˆ¶å¹¶å‘æ•°ï¼Œé¿å…è¿‡è½½
- æ•°æ®åº“è¿æ¥å¯èƒ½éœ€è¦è¿æ¥æ± 

### æ–¹æ¡ˆ2ï¼šçœŸæ­£çš„æ‰¹é‡APIï¼ˆå¦‚æœæ”¯æŒï¼‰

å¦‚æœç«å±±å¼•æ“OCRæ”¯æŒæ‰¹é‡æ¥å£ï¼Œå¯ä»¥ä¸€æ¬¡æ€§å‘é€å¤šå¼ å›¾ç‰‡ï¼š

```python
# å‡è®¾ç«å±±å¼•æ“æ”¯æŒæ‰¹é‡OCR
ocr_results = volcengine_service.batch_extract_text(image_files)
for idx, ocr_result in enumerate(ocr_results):
    # å¤„ç†æ¯å¼ å›¾ç‰‡çš„OCRç»“æœ
    ...
```

**ä¼˜ç‚¹**ï¼š
- æ•ˆç‡æœ€é«˜
- APIè°ƒç”¨æ¬¡æ•°æœ€å°‘
- ç½‘ç»œå¼€é”€æœ€å°

**ç¼ºç‚¹**ï¼š
- éœ€è¦ç«å±±å¼•æ“APIæ”¯æŒæ‰¹é‡æ¥å£
- é”™è¯¯å¤„ç†æ›´å¤æ‚ï¼ˆéœ€è¦åŒºåˆ†å“ªäº›å›¾ç‰‡å¤±è´¥ï¼‰
- å¦‚æœæ‰¹é‡ä¸­æœ‰ä¸€å¼ å¤±è´¥ï¼Œå¯èƒ½å½±å“æ•´æ‰¹

### æ–¹æ¡ˆ3ï¼šæ··åˆæ–¹æ¡ˆ

ç»“åˆä¸¤ç§æ–¹å¼ï¼š
- å°æ‰¹é‡ï¼ˆâ‰¤5å¼ ï¼‰ï¼šä½¿ç”¨æ‰¹é‡APIï¼ˆå¦‚æœæ”¯æŒï¼‰
- å¤§æ‰¹é‡ï¼ˆ>5å¼ ï¼‰ï¼šä½¿ç”¨å¹¶è¡Œå¤„ç†

## æ¨èå®ç°

**å»ºè®®ä½¿ç”¨æ–¹æ¡ˆ1ï¼ˆå¹¶è¡Œå¤„ç†ï¼‰**ï¼Œå› ä¸ºï¼š
1. âœ… ä¸ä¾èµ–APIæ˜¯å¦æ”¯æŒæ‰¹é‡
2. âœ… æé«˜å¤„ç†é€Ÿåº¦
3. âœ… ä¿æŒé”™è¯¯éš”ç¦»
4. âœ… å®ç°ç®€å•

## å®ç°ç¤ºä¾‹

```python
from concurrent.futures import ThreadPoolExecutor, as_completed
import threading

# åœ¨æ‰¹é‡æ¥å£ä¸­ä½¿ç”¨
MAX_WORKERS = 5  # æœ€å¤§å¹¶å‘æ•°

def process_single_question(q_data, idx):
    """å¤„ç†å•ä¸ªé¢˜ç›®ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰"""
    try:
        logger.info(f"[API] ğŸ“ å¤„ç†é¢˜ç›® {idx+1}")
        result = question_service.analyze_question_from_image(
            image_file=q_data['image_file'],
            frontend_raw_text=q_data['raw_text'],
            frontend_question_text=q_data['question_text'],
            frontend_options=q_data['options'],
            question_type=q_data['question_type'],
            force_reanalyze=q_data['force_reanalyze']
        )
        logger.info(f"[API] âœ… é¢˜ç›® {idx+1} å¤„ç†æˆåŠŸ")
        return {
            'success': True,
            'question': result,
            'error': None,
            'index': idx
        }
    except Exception as e:
        logger.error(f"[API] âŒ é¢˜ç›® {idx+1} å¤„ç†å¤±è´¥: {e}")
        return {
            'success': False,
            'question': None,
            'error': {'code': 500, 'message': str(e)},
            'index': idx
        }

# å¹¶è¡Œå¤„ç†
logger.info(f"[API] ğŸ” å¼€å§‹å¹¶è¡Œæ‰¹é‡å¤„ç† {len(questions_data)} ä¸ªé¢˜ç›®ï¼ˆå¹¶å‘æ•°: {MAX_WORKERS}ï¼‰...")

results = [None] * len(questions_data)
with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
    # æäº¤æ‰€æœ‰ä»»åŠ¡
    future_to_idx = {
        executor.submit(process_single_question, q_data, idx): idx
        for idx, q_data in enumerate(questions_data)
    }
    
    # æ”¶é›†ç»“æœï¼ˆæŒ‰å®Œæˆé¡ºåºï¼‰
    for future in as_completed(future_to_idx):
        result = future.result()
        results[result['index']] = result
```

## æ€§èƒ½å¯¹æ¯”

å‡è®¾å¤„ç†10å¼ å›¾ç‰‡ï¼Œæ¯å¼ éœ€è¦2ç§’ï¼š

| æ–¹æ¡ˆ | å¤„ç†æ—¶é—´ | APIè°ƒç”¨æ¬¡æ•° | é”™è¯¯éš”ç¦» |
|------|---------|------------|---------|
| å½“å‰ï¼ˆé¡ºåºï¼‰ | 20ç§’ | 10æ¬¡ | âœ… |
| å¹¶è¡Œï¼ˆ5å¹¶å‘ï¼‰ | 4ç§’ | 10æ¬¡ | âœ… |
| æ‰¹é‡API | 2-3ç§’ | 1æ¬¡ | âš ï¸ |

## æ³¨æ„äº‹é¡¹

1. **å¹¶å‘æ•°æ§åˆ¶**ï¼šå»ºè®®è®¾ç½®ä¸º3-5ï¼Œé¿å…è¿‡è½½
2. **æ•°æ®åº“è¿æ¥**ï¼šç¡®ä¿ä½¿ç”¨è¿æ¥æ± ï¼Œé¿å…è¿æ¥æ•°è¿‡å¤š
3. **å†…å­˜ä½¿ç”¨**ï¼šæ‰¹é‡å¤„ç†æ—¶æ³¨æ„å†…å­˜å ç”¨
4. **é”™è¯¯å¤„ç†**ï¼šä¿æŒéƒ¨åˆ†æˆåŠŸçš„ç‰¹æ€§

