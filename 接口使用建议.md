# APIæ¥å£ä½¿ç”¨å»ºè®®

## ğŸ“‹ é—®é¢˜è¯´æ˜

æ ¹æ®é”™è¯¯æ—¥å¿—åˆ†æï¼Œå½“å‰é‡åˆ°çš„ä¸»è¦é—®é¢˜ï¼š

### 1. ç«å±±å¼•æ“Visionæ¨¡å‹è¿”å›æ ¼å¼é—®é¢˜

`/api/questions/analyze/batch` æ¥å£ä½¿ç”¨çš„ç«å±±å¼•æ“Visionæ¨¡å‹è¿”å›çš„æ˜¯**å®Œæ•´çš„ç­”æ¡ˆè§£ææ–‡æœ¬**ï¼ˆMarkdownæ ¼å¼ï¼‰ï¼Œè€Œä¸æ˜¯JSONæ ¼å¼çš„é¢˜ç›®æå–ç»“æœã€‚

**é”™è¯¯ç¤ºä¾‹**ï¼š
```
visionæ¨¡å‹è¿”å›çš„ä¸æ˜¯æœ‰æ•ˆJSONæ ¼å¼
```

### 2. è¯·æ±‚è¶…æ—¶é—®é¢˜

éƒ¨åˆ†è¯·æ±‚åœ¨15ç§’å†…è¶…æ—¶ï¼Œå¯¼è‡´å¤„ç†å¤±è´¥ã€‚

---

## âœ… æ¨èæ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä½¿ç”¨æ‰¹é‡æå–æ¥å£ï¼ˆæ¨èï¼‰â­

**æ¥å£**: `POST /api/questions/extract/batch`

**ç‰¹ç‚¹**:
- âœ… ä½¿ç”¨**æœ¬åœ°OCR**ï¼ˆå…è´¹ã€å¿«é€Ÿã€ç¨³å®šï¼‰
- âœ… ä½¿ç”¨**DeepSeek AI**ï¼ˆè´¹ç”¨æœ€ä½ï¼Œå‡†ç¡®ç‡é«˜ï¼‰
- âœ… é«˜å¹¶å‘å¤„ç†ï¼ˆé»˜è®¤10ä¸ªå¹¶å‘ï¼Œ50é¢˜çº¦2-3åˆ†é’Ÿï¼‰
- âœ… **æ”¯æŒå‰ç«¯æä¾›OCRç»“æœ**
- âœ… **è‡ªåŠ¨æ£€æµ‹é‡å¤é¢˜ç›®ï¼Œä»é¢˜åº“ç›´æ¥æå–**
- âœ… åŒ…å«é¢˜ç›®åˆ†ç±»å’Œåˆæ­¥ç­”æ¡ˆ
- âœ… ä¸å­˜å…¥æ•°æ®åº“ï¼ˆä»…æå–ï¼‰

**é€‚ç”¨åœºæ™¯**: éœ€è¦å¿«é€Ÿæå–å¤§é‡é¢˜ç›®å†…å®¹ï¼Œä¸éœ€è¦ç«‹å³å­˜å…¥æ•°æ®åº“

**è¯·æ±‚ç¤ºä¾‹**:
```javascript
const formData = new FormData();
files.forEach(file => {
  formData.append('images[]', file);
});

// å¦‚æœæœ‰å‰ç«¯OCRç»“æœï¼Œä¹Ÿä¸€èµ·å‘é€
const ocrTexts = ['OCRæ–‡æœ¬1', 'OCRæ–‡æœ¬2', ...];
formData.append('ocr_texts[]', JSON.stringify(ocrTexts));

formData.append('max_workers', '10');

fetch('/api/questions/extract/batch', {
  method: 'POST',
  body: formData
});
```

---

### æ–¹æ¡ˆ2ï¼šä½¿ç”¨å•ä¸ªåˆ†ææ¥å£ï¼ˆå­˜å…¥æ•°æ®åº“ï¼‰

**æ¥å£**: `POST /api/questions/analyze`

**ç‰¹ç‚¹**:
- âœ… å­˜å…¥æ•°æ®åº“ï¼Œå¯åç»­è·å–è¯¦æƒ…
- âš ï¸ ä½¿ç”¨ç«å±±å¼•æ“Visionæ¨¡å‹ï¼ˆå¯èƒ½è¿”å›æ ¼å¼ä¸å…¼å®¹ï¼‰
- âš ï¸ å•é¢˜å¤„ç†ï¼Œæ‰¹é‡éœ€è¦å¾ªç¯è°ƒç”¨

**é€‚ç”¨åœºæ™¯**: éœ€è¦å­˜å…¥æ•°æ®åº“å¹¶è·å–å®Œæ•´è¯¦æƒ…ï¼ˆç­”æ¡ˆã€è§£æç­‰ï¼‰

---

## ğŸ”§ å½“å‰é—®é¢˜ä¿®å¤

### å·²ä¿®å¤çš„é—®é¢˜ï¼š

1. âœ… **BytesIOå¯¹è±¡å…¼å®¹æ€§**ï¼šä¿®å¤äº†`save_image`æ–¹æ³•ï¼Œç°åœ¨å¯ä»¥æ­£ç¡®å¤„ç†`BytesIO`å¯¹è±¡
2. âœ… **æ”¹è¿›çš„Prompt**ï¼šç«å±±å¼•æ“Visionæ¨¡å‹çš„promptæ›´åŠ æ˜ç¡®ï¼Œè¦æ±‚è¿”å›JSONæ ¼å¼
3. âœ… **å¢å¼ºçš„JSONè§£æ**ï¼šæ”¯æŒå¤šç§JSONæ¨¡å¼åŒ¹é…å’Œé™çº§å¤„ç†

### å¾…ä¼˜åŒ–çš„é—®é¢˜ï¼š

1. âš ï¸ **ç«å±±å¼•æ“Visionæ¨¡å‹æ ¼å¼**ï¼šæ¨¡å‹è¿”å›çš„æ˜¯ç­”æ¡ˆè§£æï¼Œè€Œä¸æ˜¯JSONæ ¼å¼çš„é¢˜ç›®æå–
   - **å»ºè®®**ï¼šä½¿ç”¨æœ¬åœ°OCR+DeepSeekæ–¹æ¡ˆï¼ˆ`/api/questions/extract/batch`ï¼‰
   - æˆ–ï¼šç­‰å¾…ç«å±±å¼•æ“æ¨¡å‹ä¼˜åŒ–ï¼Œè¿”å›JSONæ ¼å¼

2. âš ï¸ **è¯·æ±‚è¶…æ—¶**ï¼šéƒ¨åˆ†è¯·æ±‚åœ¨15ç§’å†…è¶…æ—¶
   - **å»ºè®®**ï¼šå¢åŠ è¶…æ—¶æ—¶é—´ï¼Œæˆ–ä½¿ç”¨æœ¬åœ°OCRæ–¹æ¡ˆï¼ˆæ›´å¿«æ›´ç¨³å®šï¼‰

---

## ğŸ“Š æ¥å£å¯¹æ¯”

| æ¥å£ | OCRæ–¹æ¡ˆ | AIæ–¹æ¡ˆ | é€Ÿåº¦ | è´¹ç”¨ | å‡†ç¡®ç‡ | æ¨èåº¦ |
|------|---------|--------|------|------|--------|--------|
| `/api/questions/extract/batch` | æœ¬åœ°OCR | DeepSeek | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| `/api/questions/analyze/batch` | ç«å±±å¼•æ“Vision | - | â­â­â­ | â­â­â­ | â­â­â­ | â­â­â­ |

---

## ğŸ’¡ æœ€ä½³å®è·µ

### æ¨èå·¥ä½œæµç¨‹ï¼š

```
1. å‰ç«¯OCRè¯†åˆ«ï¼ˆå¯é€‰ï¼‰
   â†“
2. è°ƒç”¨æ‰¹é‡æå–æ¥å£ï¼ˆ/api/questions/extract/batchï¼‰
   - ä¼ é€’å›¾ç‰‡å’ŒOCRç»“æœ
   - è·å–é¢˜ç›®å†…å®¹ã€åˆ†ç±»ã€åˆæ­¥ç­”æ¡ˆ
   â†“
3. å¦‚æœæ‰¾åˆ°é‡å¤é¢˜ï¼Œç›´æ¥ä»ç»“æœä¸­è·å–
   â†“
4. å¦‚æœæ˜¯æ–°é¢˜ï¼Œå¯é€‰æ‹©å­˜å…¥æ•°æ®åº“ï¼š
   - è°ƒç”¨ /api/questions/analyzeï¼ˆå•ä¸ªï¼‰
   - æˆ–æ‰¹é‡è°ƒç”¨ /api/questions/analyze/batch
```

---

## ğŸ” æ•…éšœæ’æŸ¥

å¦‚æœé‡åˆ°JSONæ ¼å¼é”™è¯¯ï¼š

1. **æ£€æŸ¥æ—¥å¿—**ï¼šæŸ¥çœ‹è¿”å›å†…å®¹çš„å‰500å­—ç¬¦
2. **ä½¿ç”¨æ¨èæ¥å£**ï¼šæ”¹ç”¨`/api/questions/extract/batch`ï¼ˆæœ¬åœ°OCR+DeepSeekï¼‰
3. **æä¾›å‰ç«¯OCRç»“æœ**ï¼šå¯ä»¥åŠ å¿«å¤„ç†é€Ÿåº¦ï¼Œå‡å°‘é”™è¯¯

å¦‚æœé‡åˆ°è¶…æ—¶ï¼š

1. **å‡å°‘å¹¶å‘æ•°**ï¼šå°†`max_workers`ä»10é™åˆ°5
2. **åˆ†æ‰¹å¤„ç†**ï¼šæ¯æ¬¡å¤„ç†10-20é¢˜ï¼Œè€Œä¸æ˜¯50é¢˜
3. **ä½¿ç”¨æœ¬åœ°OCRæ–¹æ¡ˆ**ï¼š`/api/questions/extract/batch`æ›´ç¨³å®š

---

## ğŸ“ ä»£ç ç¤ºä¾‹

### æ¨èï¼šæ‰¹é‡æå–æ¥å£

```javascript
// æ‰¹é‡æå–é¢˜ç›®ï¼ˆæ¨èï¼‰
async function batchExtractQuestions(files, frontendOCRTexts = []) {
  const formData = new FormData();
  
  // æ·»åŠ å›¾ç‰‡
  files.forEach(file => {
    formData.append('images[]', file);
  });
  
  // æ·»åŠ å‰ç«¯OCRç»“æœï¼ˆå¦‚æœæœ‰ï¼‰
  if (frontendOCRTexts.length > 0) {
    formData.append('ocr_texts[]', JSON.stringify(frontendOCRTexts));
  }
  
  // è®¾ç½®å¹¶å‘æ•°
  formData.append('max_workers', '10');
  
  try {
    const response = await fetch('/api/questions/extract/batch', {
      method: 'POST',
      body: formData,
      timeout: 300000 // 5åˆ†é’Ÿè¶…æ—¶ï¼ˆ50é¢˜ï¼‰
    });
    
    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.error || 'æ‰¹é‡æå–å¤±è´¥');
    }
    
    // å¤„ç†ç»“æœ
    data.results.forEach((result, index) => {
      if (result.success) {
        console.log(`é¢˜ç›®${index+1}:`, result.question_text);
        console.log('é€‰é¡¹:', result.options);
        console.log('é¢˜ç›®ç±»å‹:', result.question_type);
        console.log('åˆæ­¥ç­”æ¡ˆ:', result.preliminary_answer);
        
        if (result.is_duplicate) {
          console.log('âœ… è¿™æ˜¯é‡å¤é¢˜ï¼Œç›´æ¥ä»é¢˜åº“æå–');
        }
      } else {
        console.error(`é¢˜ç›®${index+1}å¤±è´¥:`, result.error);
      }
    });
    
    console.log('ç»Ÿè®¡:', data.statistics);
    
    return data;
  } catch (error) {
    console.error('æ‰¹é‡æå–é”™è¯¯:', error);
    throw error;
  }
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¼˜å…ˆä½¿ç”¨æœ¬åœ°OCRæ–¹æ¡ˆ**ï¼š`/api/questions/extract/batch`æ›´ç¨³å®šã€æ›´å¿«ã€æ›´ä¾¿å®œ
2. **æä¾›å‰ç«¯OCRç»“æœ**ï¼šå¯ä»¥åŠ å¿«å¤„ç†é€Ÿåº¦ï¼Œå‡å°‘åç«¯OCRè°ƒç”¨
3. **åˆç†è®¾ç½®å¹¶å‘æ•°**ï¼šæ¨è10ä¸ªå¹¶å‘ï¼Œå¯æ ¹æ®æœåŠ¡å™¨æ€§èƒ½è°ƒæ•´ï¼ˆèŒƒå›´3-20ï¼‰
4. **æ‰¹é‡å¤§å°é™åˆ¶**ï¼š
   - `/api/questions/extract/batch`: æœ€å¤š100é¢˜
   - `/api/questions/analyze/batch`: æœ€å¤š20é¢˜

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨ï¼ˆ`GET /api/health`ï¼‰
2. å›¾ç‰‡æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆæ”¯æŒ jpg/png/gif/bmpï¼‰
3. è¯·æ±‚æ ¼å¼æ˜¯å¦æ­£ç¡®
4. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
