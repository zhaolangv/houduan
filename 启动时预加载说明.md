# 启动时预加载服务说明

## 📋 概述

为了提高首次请求的响应速度，应用支持在启动时预加载 OCR 服务（PaddleOCR）。这样可以避免首次请求时的模型加载延迟。

---

## ✅ 功能说明

### OCR 服务预加载

**默认行为**：✅ **启用**（默认预加载）

- 在 Flask 服务启动前，自动初始化 PaddleOCR 模型
- 将模型加载到内存，避免首次请求的延迟
- 显示加载进度和状态信息

---

## ⚙️ 配置选项

### 环境变量

可以通过环境变量控制预加载行为：

#### 1. `PRELOAD_OCR`

控制是否在启动时预加载 OCR 服务。

- **默认值**：`true`
- **可选值**：`true` / `false` / `1` / `0` / `yes` / `no`

**示例**：
```bash
# .env 文件
PRELOAD_OCR=true   # 启用预加载（默认）
PRELOAD_OCR=false  # 禁用预加载
```

#### 2. `PRELOAD_OCR_TEST`

控制是否在预加载后进行测试识别（验证模型是否完全加载）。

- **默认值**：`false`
- **可选值**：`true` / `false` / `1` / `0` / `yes` / `no`

**示例**：
```bash
# .env 文件
PRELOAD_OCR_TEST=true   # 启用测试识别（会增加启动时间）
PRELOAD_OCR_TEST=false  # 禁用测试识别（默认，更快启动）
```

---

## 🚀 使用方式

### 方式1: 使用默认配置（推荐）

直接启动应用，OCR 服务会自动预加载：

```bash
python app.py
```

**输出示例**：
```
============================================================
正在预加载OCR服务（PaddleOCR）...
============================================================
📦 正在初始化PaddleOCR模型...
   提示: 首次启动可能需要下载模型文件，请耐心等待
[OCR] 使用PaddleOCR引擎（基础参数）
✅ OCR服务初始化完成！耗时: 3.2秒
   📝 使用的引擎: PaddleOCR
   💡 提示: 已跳过测试识别（设置 PRELOAD_OCR_TEST=true 可启用测试）

============================================================
Flask服务启动中...
============================================================
```

### 方式2: 禁用预加载

如果需要快速启动（跳过 OCR 预加载）：

```bash
# 设置环境变量
export PRELOAD_OCR=false

# 或添加到 .env 文件
echo "PRELOAD_OCR=false" >> .env

# 然后启动
python app.py
```

**输出示例**：
```
============================================================
⏭️  跳过OCR服务预加载（PRELOAD_OCR=false）
============================================================
   提示: OCR服务将在首次请求时初始化
```

### 方式3: 启用测试识别

如果需要验证 OCR 模型是否完全加载：

```bash
# 设置环境变量
export PRELOAD_OCR_TEST=true

# 或添加到 .env 文件
echo "PRELOAD_OCR_TEST=true" >> .env

# 然后启动
python app.py
```

**输出示例**：
```
============================================================
正在预加载OCR服务（PaddleOCR）...
============================================================
📦 正在初始化PaddleOCR模型...
   提示: 首次启动可能需要下载模型文件，请耐心等待
✅ OCR服务初始化完成！耗时: 3.2秒
   📝 使用的引擎: PaddleOCR
🔍 进行测试识别以确保模型已完全加载...
✅ OCR测试识别成功！测试耗时: 0.5秒
```

---

## ⏱️ 启动时间说明

### 首次启动

- **OCR 预加载**：约 3-10 秒（需要下载模型文件）
- **测试识别**：额外约 0.5-1 秒

### 后续启动

- **OCR 预加载**：约 1-3 秒（模型已在本地）
- **测试识别**：额外约 0.5 秒

### 跳过预加载

- **启动时间**：几乎瞬间（< 0.1 秒）
- **首次请求**：需要额外 3-10 秒加载模型

---

## 📊 性能对比

### 启用预加载

```
启动时间：3-10秒
首次请求：0.5-2秒（无需加载模型）
```

### 禁用预加载

```
启动时间：< 0.1秒
首次请求：3-12秒（需要加载模型）
```

**建议**：
- ✅ **开发环境**：可以禁用预加载，快速启动
- ✅ **生产环境**：建议启用预加载，提供更好的用户体验

---

## 🔍 验证预加载状态

### 方式1: 查看启动日志

启动时会显示 OCR 服务的加载状态：

```
✅ OCR服务初始化完成！耗时: 3.2秒
   📝 使用的引擎: PaddleOCR
```

### 方式2: 健康检查接口

可以通过健康检查接口查看服务状态：

```bash
curl http://localhost:5000/api/health
```

---

## ❓ 常见问题

### Q1: 预加载会占用很多内存吗？

**A**: 是的，PaddleOCR 模型会占用约 200-500MB 内存。如果内存有限，可以考虑禁用预加载。

### Q2: 首次启动很慢，正常吗？

**A**: 正常。首次启动需要下载模型文件（约 200-300MB），可能需要几分钟。后续启动会快很多。

### Q3: 如何查看模型下载进度？

**A**: PaddleOCR 会在控制台显示下载进度，请查看启动日志。

### Q4: 可以只加载模型而不测试吗？

**A**: 可以。默认配置就是只加载模型，不进行测试识别。设置 `PRELOAD_OCR_TEST=false`（默认值）即可。

### Q5: 预加载失败会影响服务吗？

**A**: 不会。如果预加载失败，服务仍会正常启动，OCR 会在首次请求时尝试初始化。

---

## 🔧 故障排查

### 问题1: 预加载很慢或卡住

**可能原因**：
- 首次下载模型文件
- 网络连接问题
- 磁盘空间不足

**解决方案**：
1. 等待模型下载完成（首次启动）
2. 检查网络连接
3. 检查磁盘空间（需要至少 500MB）

### 问题2: 预加载失败

**可能原因**：
- PaddleOCR 未安装
- 模型文件损坏
- 内存不足

**解决方案**：
1. 安装 PaddleOCR：`pip install paddlepaddle paddleocr`
2. 删除模型缓存目录，重新下载
3. 增加系统内存或禁用预加载

### 问题3: 启动后首次请求仍很慢

**可能原因**：
- 预加载未成功
- 使用了不同的 OCR 引擎

**解决方案**：
1. 查看启动日志，确认 OCR 是否预加载成功
2. 检查是否使用了 Tesseract 等其他 OCR 引擎
3. 启用测试识别（`PRELOAD_OCR_TEST=true`）验证模型是否完全加载

---

## 📝 配置文件示例

### .env 文件示例

```env
# OCR 服务预加载配置
PRELOAD_OCR=true          # 启用预加载（默认）
PRELOAD_OCR_TEST=false    # 禁用测试识别（默认，更快启动）

# 其他配置...
AI_API_KEY=your_api_key
DATABASE_URL=your_database_url
```

---

## 🎯 最佳实践

### 开发环境

```env
PRELOAD_OCR=false         # 快速启动，跳过预加载
```

### 生产环境

```env
PRELOAD_OCR=true          # 预加载，提供更好的用户体验
PRELOAD_OCR_TEST=false    # 不测试，加快启动速度
```

### 测试环境

```env
PRELOAD_OCR=true          # 预加载
PRELOAD_OCR_TEST=true     # 测试识别，确保模型正常
```

---

## 📄 相关文档

- `前端修改指南.md` - 前端数据格式说明
- `前端API接口文档.md` - 完整API接口文档
- `功能增强说明.md` - 功能说明
