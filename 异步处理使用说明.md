# å¼‚æ­¥æ‰¹é‡å¤„ç†æ¥å£ä½¿ç”¨è¯´æ˜

## ğŸš€ æ¦‚è¿°

ä¸ºäº†è§£å†³ HTTP 524 è¶…æ—¶é—®é¢˜ï¼Œå·²å®ç°**å¼‚æ­¥æ‰¹é‡å¤„ç†æ¥å£**ã€‚æ¥å£ç«‹å³è¿”å›ä»»åŠ¡IDï¼Œåç«¯åœ¨åå°å¤„ç†ï¼Œå®¢æˆ·ç«¯è½®è¯¢æŸ¥è¯¢ç»“æœã€‚

**ä¼˜åŠ¿**ï¼š
- âœ… **ä¸ä¼šè¶…æ—¶**ï¼šç«‹å³è¿”å›ä»»åŠ¡IDï¼ˆ< 1ç§’ï¼‰
- âœ… **æ”¯æŒå¤§é‡å›¾ç‰‡**ï¼šä¸å—è¶…æ—¶é™åˆ¶
- âœ… **æ˜¾ç¤ºè¿›åº¦**ï¼šå¯ä»¥æŸ¥è¯¢å¤„ç†è¿›åº¦
- âœ… **æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ**ï¼šç”¨æˆ·å¯ä»¥éšæ—¶æŸ¥è¯¢çŠ¶æ€

## ğŸ“¡ API æ¥å£

### 1. æäº¤å¼‚æ­¥ä»»åŠ¡

**æ¥å£**: `POST /api/questions/extract/batch/async`

**è¯·æ±‚æ ¼å¼**ï¼šä¸åŒæ­¥æ¥å£å®Œå…¨ç›¸åŒ

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```json
{
  "images": [
    {
      "data": "data:image/jpeg;base64,...",
      "filename": "image1.jpg",
      "ocr_text": "å‰ç«¯OCRç»“æœï¼ˆå¯é€‰ï¼‰"
    },
    {
      "data": "data:image/jpeg;base64,...",
      "filename": "image2.jpg"
    }
  ],
  "max_workers": 10
}
```

**å“åº”**ï¼ˆç«‹å³è¿”å›ï¼Œ< 1ç§’ï¼‰ï¼š
```json
{
  "success": true,
  "task_id": "ä»»åŠ¡IDï¼ˆUUIDï¼‰",
  "message": "ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†ä¸­",
  "status_url": "/api/tasks/{task_id}/status",
  "result_url": "/api/tasks/{task_id}/result"
}
```

**HTTP çŠ¶æ€ç **: `202 Accepted`

### 2. æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€

**æ¥å£**: `GET /api/tasks/{task_id}/status`

**å“åº”**ï¼š
```json
{
  "success": true,
  "task": {
    "id": "ä»»åŠ¡ID",
    "type": "batch_extract",
    "status": "pending|processing|completed|failed",
    "progress": {
      "total": 10,
      "completed": 5,
      "failed": 0,
      "current_item": null
    },
    "created_at": "2025-12-07T20:50:00",
    "started_at": "2025-12-07T20:50:01",
    "completed_at": null,
    "total_time": null,
    "has_result": false,
    "has_error": false
  }
}
```

### 3. è·å–ä»»åŠ¡ç»“æœ

**æ¥å£**: `GET /api/tasks/{task_id}/result`

**å“åº”ï¼ˆä»»åŠ¡å®Œæˆæ—¶ï¼‰**ï¼š
```json
{
  "success": true,
  "status": "completed",
  "result": {
    "results": [
      {
        "success": true,
        "question_text": "...",
        "options": ["A. ...", "B. ..."],
        "ocr_time": 2.5,
        "ai_time": 3.2,
        "total_time": 5.7,
        "cost": 0.000117
      }
    ],
    "statistics": {
      "total": 10,
      "success_count": 9,
      "failed_count": 1,
      "total_time": 57.3,
      "avg_time_per_question": 6.4,
      "total_cost": 0.001053
    }
  }
}
```

**å“åº”ï¼ˆä»»åŠ¡è¿›è¡Œä¸­ï¼‰**ï¼š
```json
{
  "success": true,
  "status": "processing",
  "message": "ä»»åŠ¡å°šæœªå®Œæˆï¼Œè¯·ç¨åå†è¯•",
  "progress": {
    "total": 10,
    "completed": 5,
    "failed": 0
  }
}
```

**å“åº”ï¼ˆä»»åŠ¡å¤±è´¥ï¼‰**ï¼š
```json
{
  "success": false,
  "status": "failed",
  "error": "é”™è¯¯ä¿¡æ¯"
}
```

## ğŸ’» å®¢æˆ·ç«¯å®ç°ç¤ºä¾‹

### Kotlin/Android ç¤ºä¾‹

```kotlin
// 1. æäº¤å¼‚æ­¥ä»»åŠ¡
fun submitBatchAsync(images: List<ImageData>): TaskResponse {
    val request = BatchQuestionRequest(
        images = images,
        max_workers = 10
    )
    
    val response = apiClient.post("/api/questions/extract/batch/async", request)
    return response.body() // åŒ…å« task_id
}

// 2. è½®è¯¢æŸ¥è¯¢çŠ¶æ€
suspend fun pollTaskUntilComplete(taskId: String): TaskResult {
    var status: TaskStatus
    
    while (true) {
        // æŸ¥è¯¢çŠ¶æ€
        val statusResponse = apiClient.get("/api/tasks/$taskId/status")
        status = statusResponse.body().task
        
        when (status.status) {
            "completed" -> {
                // è·å–ç»“æœ
                val resultResponse = apiClient.get("/api/tasks/$taskId/result")
                return resultResponse.body().result
            }
            "failed" -> {
                val resultResponse = apiClient.get("/api/tasks/$taskId/result")
                throw Exception(resultResponse.body().error)
            }
            "pending", "processing" -> {
                // æ˜¾ç¤ºè¿›åº¦
                updateProgress(status.progress)
                delay(2000) // ç­‰å¾…2ç§’åç»§ç»­æŸ¥è¯¢
            }
        }
    }
}

// 3. ä½¿ç”¨ç¤ºä¾‹
fun processBatch(images: List<ImageData>) {
    lifecycleScope.launch {
        try {
            // æäº¤ä»»åŠ¡
            val submitResponse = submitBatchAsync(images)
            val taskId = submitResponse.task_id
            
            showMessage("ä»»åŠ¡å·²æäº¤ï¼Œä»»åŠ¡ID: $taskId")
            
            // è½®è¯¢ç›´åˆ°å®Œæˆ
            val result = pollTaskUntilComplete(taskId)
            
            // å¤„ç†ç»“æœ
            handleResults(result.results)
            
        } catch (e: Exception) {
            showError("å¤„ç†å¤±è´¥: ${e.message}")
        }
    }
}
```

### JavaScript/å‰ç«¯ç¤ºä¾‹

```javascript
// 1. æäº¤å¼‚æ­¥ä»»åŠ¡
async function submitBatchAsync(images) {
    const response = await fetch('/api/questions/extract/batch/async', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            images: images,
            max_workers: 10
        })
    });
    return await response.json(); // { task_id, status_url, result_url }
}

// 2. è½®è¯¢æŸ¥è¯¢çŠ¶æ€
async function pollTaskUntilComplete(taskId) {
    while (true) {
        // æŸ¥è¯¢çŠ¶æ€
        const statusResponse = await fetch(`/api/tasks/${taskId}/status`);
        const statusData = await statusResponse.json();
        const task = statusData.task;
        
        // æ›´æ–°è¿›åº¦
        updateProgress(task.progress);
        
        if (task.status === 'completed') {
            // è·å–ç»“æœ
            const resultResponse = await fetch(`/api/tasks/${taskId}/result`);
            const resultData = await resultResponse.json();
            return resultData.result;
        } else if (task.status === 'failed') {
            const resultResponse = await fetch(`/api/tasks/${taskId}/result`);
            const resultData = await resultResponse.json();
            throw new Error(resultData.error);
        }
        
        // ç­‰å¾…2ç§’åç»§ç»­æŸ¥è¯¢
        await new Promise(resolve => setTimeout(resolve, 2000));
    }
}

// 3. ä½¿ç”¨ç¤ºä¾‹
async function processBatch(images) {
    try {
        // æäº¤ä»»åŠ¡
        const submitResult = await submitBatchAsync(images);
        console.log('ä»»åŠ¡å·²æäº¤:', submitResult.task_id);
        
        // è½®è¯¢ç›´åˆ°å®Œæˆ
        const result = await pollTaskUntilComplete(submitResult.task_id);
        
        // å¤„ç†ç»“æœ
        console.log('å¤„ç†å®Œæˆ:', result);
        displayResults(result.results);
        
    } catch (error) {
        console.error('å¤„ç†å¤±è´¥:', error);
        showError(error.message);
    }
}
```

## â±ï¸ è½®è¯¢é¢‘ç‡å»ºè®®

- **æ¨è**: æ¯ **2-3 ç§’** æŸ¥è¯¢ä¸€æ¬¡çŠ¶æ€
- **æœ€å¤§é—´éš”**: ä¸è¶…è¿‡ 5 ç§’
- **æœ€å°é—´éš”**: ä¸å»ºè®® < 1 ç§’ï¼ˆé¿å…æœåŠ¡å™¨å‹åŠ›ï¼‰

## ğŸ“Š è¿›åº¦æ˜¾ç¤ºç¤ºä¾‹

```kotlin
fun updateProgress(progress: Progress) {
    val percentage = if (progress.total > 0) {
        (progress.completed.toFloat() / progress.total * 100).toInt()
    } else 0
    
    progressBar.progress = percentage
    statusText.text = "å¤„ç†ä¸­: ${progress.completed}/${progress.total} (${percentage}%)"
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä»»åŠ¡ä¿ç•™æ—¶é—´**: ä»»åŠ¡ç»“æœä¿ç•™ **2 å°æ—¶**ï¼Œå®ŒæˆååŠæ—¶è·å–
2. **ä»»åŠ¡ID**: ä»»åŠ¡IDæ˜¯UUIDï¼Œéœ€è¦å¦¥å–„ä¿å­˜
3. **é”™è¯¯å¤„ç†**: å¦‚æœä»»åŠ¡å¤±è´¥ï¼Œä¼šè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œéœ€è¦å¤„ç†
4. **ç½‘ç»œä¸­æ–­**: å¦‚æœç½‘ç»œä¸­æ–­ï¼Œå¯ä»¥ä½¿ç”¨ä»»åŠ¡IDé‡æ–°æŸ¥è¯¢

## ğŸ”„ è¿ç§»æŒ‡å—

### ä»åŒæ­¥æ¥å£è¿ç§»åˆ°å¼‚æ­¥æ¥å£

**ä¹‹å‰ï¼ˆåŒæ­¥ï¼‰**ï¼š
```kotlin
val response = apiClient.post("/api/questions/extract/batch", request)
val result = response.body() // ç›´æ¥è·å–ç»“æœ
```

**ç°åœ¨ï¼ˆå¼‚æ­¥ï¼‰**ï¼š
```kotlin
// 1. æäº¤ä»»åŠ¡
val submitResponse = apiClient.post("/api/questions/extract/batch/async", request)
val taskId = submitResponse.task_id

// 2. è½®è¯¢æŸ¥è¯¢
val result = pollTaskUntilComplete(taskId)
```

## ğŸ“‹ å®Œæ•´ç¤ºä¾‹ä»£ç 

å‚è€ƒ `å¼‚æ­¥å¤„ç†ä½¿ç”¨è¯´æ˜.md` æ–‡ä»¶ä¸­çš„å®Œæ•´ç¤ºä¾‹ã€‚

## âœ… ä¼˜åŠ¿å¯¹æ¯”

| ç‰¹æ€§ | åŒæ­¥æ¥å£ | å¼‚æ­¥æ¥å£ |
|------|---------|---------|
| å“åº”æ—¶é—´ | 15-120ç§’+ | < 1ç§’ |
| è¶…æ—¶é£é™© | é«˜ï¼ˆ>2åˆ†é’Ÿä¼šè¶…æ—¶ï¼‰ | æ— ï¼ˆç«‹å³è¿”å›ï¼‰ |
| è¿›åº¦æ˜¾ç¤º | ä¸æ”¯æŒ | æ”¯æŒ |
| å¤§é‡å›¾ç‰‡ | å¯èƒ½è¶…æ—¶ | å®Œå…¨æ”¯æŒ |
| ç”¨æˆ·ä½“éªŒ | ç­‰å¾…æ—¶é—´é•¿ | å¯ä»¥æ˜¾ç¤ºè¿›åº¦ |

## ğŸ¯ æ¨èä½¿ç”¨åœºæ™¯

- âœ… **å›¾ç‰‡æ•°é‡ > 5 å¼ **ï¼šä½¿ç”¨å¼‚æ­¥æ¥å£
- âœ… **ä¸ç¡®å®šå¤„ç†æ—¶é—´**ï¼šä½¿ç”¨å¼‚æ­¥æ¥å£
- âœ… **éœ€è¦æ˜¾ç¤ºè¿›åº¦**ï¼šä½¿ç”¨å¼‚æ­¥æ¥å£
- âœ… **å•å¼ æˆ–å°‘é‡å›¾ç‰‡**ï¼šå¯ä»¥ä½¿ç”¨åŒæ­¥æ¥å£ï¼ˆæ›´å¿«ï¼‰
