# 用户留存率统计功能说明

## 📊 功能概述

实现了**无需注册**的用户留存率统计系统。使用设备ID（Device ID）自动追踪用户，无需用户注册账号，即可统计：
- 总用户数
- 活跃用户数（DAU）
- 新增用户数
- 留存率（按日、按周、按月）
- Cohort留存率

---

## 🔑 核心原理

### 设备ID标识

系统使用**设备ID**来标识用户，支持以下方式：

1. **Android设备**：
   - Android ID（推荐，唯一且持久）
   - IMEI（需要权限）
   - 自定义UUID（存储在SharedPreferences）

2. **iOS设备**：
   - IDFV（Identifier for Vendor）
   - 自定义UUID（存储在Keychain）

3. **Web应用**：
   - LocalStorage中的UUID
   - Cookie中的标识符

### 数据存储

- **UserSession表**：存储用户会话信息（首次使用日期、最后活跃日期等）
- **DailyActiveUser表**：存储每日活跃用户数据（用于计算留存率）

---

## 🔌 API接口

### 1. 自动追踪（版本验证时）

系统会在**版本验证接口**自动追踪用户活动：
- `/api/version` - 检查版本时（应用启动时通常都会调用）

**请求头**（可选，但推荐）：
```
X-Device-ID: 设备ID（如Android ID）
X-App-Version: 应用版本号（如 "1.0.0"）
```

**请求参数**（可选）：
```
device_id: 设备ID（如果请求头不支持，可用参数）
app_version: 应用版本号
client_version: 客户端版本号（用于版本检查）
```

**示例**：
```bash
# 版本检查（会自动记录用户活动）
curl -H "X-Device-ID: abc123..." \
     -H "X-App-Version: 1.0.0" \
     "http://localhost:5000/api/version?client_version=1.0.0"
```

**为什么选择版本接口？**
- ✅ 应用启动时通常都会调用，能准确反映用户活跃度
- ✅ 调用频率适中，不会产生过多数据
- ✅ 不依赖具体功能使用，更通用

---

### 2. 获取用户统计数据

**接口**: `GET /api/users/stats`

**请求参数**（可选）:
- `days`: 统计最近多少天（默认30天）

**示例请求**:
```bash
curl "http://localhost:5000/api/users/stats?days=30"
```

**返回示例**:
```json
{
  "success": true,
  "data": {
    "period": {
      "start_date": "2024-12-08",
      "end_date": "2025-01-07",
      "days": 30
    },
    "total_users": 1000,
    "active_users": 500,
    "new_users": 50,
    "avg_dau": 200.5,
    "daily_active_users": [
      {
        "date": "2025-01-07",
        "count": 250
      },
      {
        "date": "2025-01-06",
        "count": 230
      }
    ]
  }
}
```

---

### 3. 获取留存率

**接口**: `GET /api/users/retention`

**请求参数**（可选）:
- `start_date`: 起始日期（YYYY-MM-DD格式，默认：7天前）
- `days`: 计算多少天的留存率（默认7天）

**示例请求**:
```bash
# 计算最近7天的留存率
curl "http://localhost:5000/api/users/retention?days=7"

# 计算指定日期的留存率
curl "http://localhost:5000/api/users/retention?start_date=2025-01-01&days=30"
```

**返回示例**:
```json
{
  "success": true,
  "data": {
    "start_date": "2025-01-01",
    "days": 7,
    "new_users": 100,
    "retention_data": [
      {
        "day": 0,
        "date": "2025-01-01",
        "retained_users": 100,
        "retention_rate": 100.0
      },
      {
        "day": 1,
        "date": "2025-01-02",
        "retained_users": 80,
        "retention_rate": 80.0
      },
      {
        "day": 7,
        "date": "2025-01-08",
        "retained_users": 50,
        "retention_rate": 50.0
      }
    ]
  }
}
```

---

### 4. 获取Cohort留存率

**接口**: `GET /api/users/cohort`

**请求参数**（可选）:
- `cohort_days`: 计算多少天的cohort（默认7天）
- `retention_days`: 追踪多少天的留存（默认30天）

**示例请求**:
```bash
curl "http://localhost:5000/api/users/cohort?cohort_days=7&retention_days=30"
```

**返回示例**:
```json
{
  "success": true,
  "data": {
    "cohort_days": 7,
    "retention_days": 30,
    "cohorts": [
      {
        "cohort_date": "2025-01-01",
        "new_users": 100,
        "retention_data": [
          {
            "day": 0,
            "date": "2025-01-01",
            "retained_users": 100,
            "retention_rate": 100.0
          },
          {
            "day": 1,
            "date": "2025-01-02",
            "retained_users": 80,
            "retention_rate": 80.0
          }
        ]
      }
    ]
  }
}
```

---

## 📱 前端集成

### Android 示例（Kotlin）

```kotlin
// 获取设备ID
fun getDeviceId(context: Context): String {
    return Settings.Secure.getString(
        context.contentResolver,
        Settings.Secure.ANDROID_ID
    ) ?: UUID.randomUUID().toString()
}

// 应用启动时检查版本（会自动记录用户活动）
fun checkVersion() {
    val deviceId = getDeviceId(context)
    val appVersion = BuildConfig.VERSION_NAME
    val clientVersion = BuildConfig.VERSION_NAME
    
    val url = "https://your-api.com/api/version?client_version=$clientVersion"
    
    val request = Request.Builder()
        .url(url)
        .addHeader("X-Device-ID", deviceId)
        .addHeader("X-App-Version", appVersion)
        .get()
        .build()
    
    client.newCall(request).enqueue(object : Callback {
        override fun onResponse(call: Call, response: Response) {
            val json = JSONObject(response.body?.string() ?: "")
            val update = json.getJSONObject("update")
            
            if (update.getBoolean("required")) {
                // 提示用户更新
                showUpdateDialog(update)
            }
        }
        
        override fun onFailure(call: Call, e: IOException) {
            Log.e("VersionCheck", "检查失败", e)
        }
    })
}
```

### React Native 示例

```javascript
import DeviceInfo from 'react-native-device-info';

// 获取设备ID
const getDeviceId = async () => {
  try {
    // Android
    if (Platform.OS === 'android') {
      return await DeviceInfo.getAndroidId();
    }
    // iOS
    return DeviceInfo.getUniqueId();
  } catch (error) {
    // 如果获取失败，使用本地存储的UUID
    let deviceId = await AsyncStorage.getItem('device_id');
    if (!deviceId) {
      deviceId = uuid.v4();
      await AsyncStorage.setItem('device_id', deviceId);
    }
    return deviceId;
  }
};

// 在API请求中添加设备ID
const analyzeQuestion = async (imageUri) => {
  const deviceId = await getDeviceId();
  const appVersion = DeviceInfo.getVersion();
  
  const formData = new FormData();
  formData.append('image', {
    uri: imageUri,
    type: 'image/jpeg',
    name: 'question.jpg',
  });
  formData.append('device_id', deviceId);
  formData.append('app_version', appVersion);
  
  const response = await fetch('https://your-api.com/api/questions/analyze', {
    method: 'POST',
    headers: {
      'X-Device-ID': deviceId,
      'X-App-Version': appVersion,
    },
    body: formData,
  });
  
  return response.json();
};
```

### Web 示例（JavaScript）

```javascript
// 获取或创建设备ID
function getDeviceId() {
  let deviceId = localStorage.getItem('device_id');
  if (!deviceId) {
    deviceId = 'web_' + uuid.v4();
    localStorage.setItem('device_id', deviceId);
  }
  return deviceId;
}

// 应用启动时检查版本（会自动记录用户活动）
async function checkVersion() {
  const deviceId = getDeviceId();
  const appVersion = '1.0.0'; // 从配置中获取
  const clientVersion = '1.0.0'; // 当前应用版本
  
  const response = await fetch(
    `/api/version?client_version=${clientVersion}`,
    {
      method: 'GET',
      headers: {
        'X-Device-ID': deviceId,
        'X-App-Version': appVersion,
      },
    }
  );
  
  const data = await response.json();
  
  if (data.update && data.update.required) {
    // 提示用户更新
    showUpdateDialog(data.update);
  }
  
  return data;
}

// 在应用启动时调用
checkVersion();
```

---

## 📊 查看统计数据

### 方式1: 使用API接口

```bash
# 查看用户统计
curl http://localhost:5000/api/users/stats?days=30

# 查看留存率
curl http://localhost:5000/api/users/retention?days=7

# 查看Cohort留存率
curl http://localhost:5000/api/users/cohort?cohort_days=7&retention_days=30
```

### 方式2: 在数据库中查询

```sql
-- 查看总用户数
SELECT COUNT(*) FROM user_sessions;

-- 查看最近7天的新增用户
SELECT COUNT(*) FROM user_sessions 
WHERE first_seen_date >= CURRENT_DATE - INTERVAL '7 days';

-- 查看今日活跃用户数
SELECT COUNT(DISTINCT device_id) FROM daily_active_users 
WHERE date = CURRENT_DATE;

-- 查看留存率（示例：7天前新增用户的留存情况）
SELECT 
    dau.date,
    COUNT(DISTINCT dau.device_id) as retained_users
FROM daily_active_users dau
JOIN user_sessions us ON dau.device_id = us.device_id
WHERE us.first_seen_date = CURRENT_DATE - INTERVAL '7 days'
GROUP BY dau.date
ORDER BY dau.date;
```

---

## 🔒 隐私保护

### 数据匿名化

- ✅ 只存储设备ID，不存储个人信息
- ✅ 设备ID可以是一串随机UUID
- ✅ 无法通过设备ID追溯到具体用户

### 合规建议

1. **隐私政策**：在应用中说明会收集匿名使用数据
2. **用户同意**：首次使用时提示用户（可选）
3. **数据保留**：定期清理旧数据（如保留90天）

---

## 📈 留存率指标说明

### 日留存率（Day 1 Retention）

- **定义**：首次使用后第1天仍然活跃的用户比例
- **计算**：`(第1天活跃用户数 / 新增用户数) * 100%`
- **意义**：衡量产品是否吸引用户

### 7日留存率（Day 7 Retention）

- **定义**：首次使用后第7天仍然活跃的用户比例
- **计算**：`(第7天活跃用户数 / 新增用户数) * 100%`
- **意义**：衡量用户粘性

### 30日留存率（Day 30 Retention）

- **定义**：首次使用后第30天仍然活跃的用户比例
- **计算**：`(第30天活跃用户数 / 新增用户数) * 100%`
- **意义**：衡量长期留存

---

## 🎯 使用场景

### 1. 监控产品健康度

```bash
# 每日查看DAU
curl http://localhost:5000/api/users/stats?days=1
```

### 2. 分析新功能影响

```bash
# 查看新功能发布后的留存率变化
curl "http://localhost:5000/api/users/retention?start_date=2025-01-01&days=30"
```

### 3. 对比不同时期的用户质量

```bash
# 对比不同cohort的留存率
curl "http://localhost:5000/api/users/cohort?cohort_days=30&retention_days=90"
```

---

## 🛠️ 数据库迁移

首次使用需要创建新表：

```bash
# 方法1: 使用Flask自动创建（推荐）
python -c "from app import app, db; app.app_context().push(); db.create_all()"

# 方法2: 使用初始化脚本
python init_db_v2.py
```

---

## 📝 注意事项

1. **设备ID稳定性**
   - Android ID在应用卸载重装后可能变化
   - 建议结合其他标识符（如用户自定义UUID）

2. **数据准确性**
   - 如果用户清除应用数据，设备ID可能变化
   - 这是匿名统计的局限性

3. **性能优化**
   - 用户活动追踪是异步的，不会影响API响应速度
   - 如果追踪失败，不会影响主功能

---

## ✅ 功能特点

- ✅ **无需注册**：用户无需创建账号
- ✅ **自动追踪**：API调用时自动记录
- ✅ **隐私友好**：只存储匿名设备ID
- ✅ **实时统计**：数据实时更新
- ✅ **多种指标**：DAU、留存率、Cohort分析

---

**功能已就绪！** 🎉

现在你的应用可以自动追踪用户留存率，无需用户注册！
