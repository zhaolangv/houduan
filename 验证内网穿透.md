# 如何验证内网穿透是否可用

## 快速验证步骤

### 步骤1：确保本地服务运行

首先，确保你的 Flask 服务正在运行：

```powershell
python app.py
```

应该看到类似输出：
```
🚀 服务启动中...
📍 API地址: http://localhost:5000
```

### 步骤2：测试本地服务

在**另一个终端**运行：

```powershell
# 使用测试脚本
.\test_tunnel.bat

# 或手动测试
curl http://localhost:5000/api/stats
```

如果返回 JSON 数据，说明本地服务正常。

### 步骤3：启动内网穿透

在**另一个终端**运行：

```powershell
# 使用脚本
.\start_tunnel_localtunnel.bat

# 或直接运行
npx localtunnel --port 5000
```

成功后会显示：
```
your url is: https://xxxx.loca.lt
```

**重要**：复制这个 URL，后续测试需要用到。

### 步骤4：测试公网访问

#### 方法1：使用测试脚本（推荐）

```powershell
.\test_tunnel_public.bat https://xxxx.loca.lt
```

#### 方法2：手动测试（推荐使用测试接口）

在**浏览器**中访问：
```
https://xxxx.loca.lt/api/test
```

或在**命令行**中：
```powershell
curl https://xxxx.loca.lt/api/test
```

**测试接口说明**：
- `/api/test` - 简单测试接口，快速响应，无需数据库
- `/api/health` - 健康检查接口，包含数据库状态
- `/api/stats` - 统计接口，需要数据库查询

#### 方法3：使用手机测试

1. 确保手机和电脑在同一网络（或使用移动数据）
2. 在手机浏览器访问：`https://xxxx.loca.lt/api/test`
3. 如果能看到 JSON 数据（包含 `"success": true`），说明内网穿透成功

## 验证清单

- [ ] 本地服务运行正常（`http://localhost:5000/api/test` 可访问）
- [ ] 内网穿透工具已启动（显示公网 URL）
- [ ] 公网 URL 可以访问（浏览器或 curl 测试 `/api/test`）
- [ ] 返回的数据包含 `"success": true`
- [ ] 健康检查接口正常（`/api/health`）

## 常见问题

### 1. 本地服务无法访问

**症状**：`curl http://localhost:5000/api/stats` 失败

**解决**：
- 检查 Flask 服务是否正在运行
- 检查端口 5000 是否被占用
- 检查防火墙设置

### 2. 内网穿透启动失败

**症状**：`npx localtunnel --port 5000` 报错

**解决**：
- 检查 Node.js 是否安装：`node --version`
- 检查网络连接
- 尝试使用其他工具（cpolar、ngrok）

### 3. 公网 URL 无法访问

**症状**：浏览器显示"无法访问此网站"或超时

**可能原因**：
- 内网穿透未正确启动
- 本地服务未运行
- 网络防火墙阻止
- localtunnel 服务不稳定（可尝试重新启动）

**解决**：
1. 确认本地服务运行：`curl http://localhost:5000/api/stats`
2. 重新启动内网穿透
3. 尝试使用其他内网穿透工具

### 4. 返回错误数据

**症状**：公网 URL 可以访问，但返回错误

**解决**：
- 检查本地服务日志
- 确认请求路径正确
- 检查 CORS 设置（如果前端调用）

## 完整测试流程

```powershell
# 终端1：启动 Flask 服务
python app.py

# 终端2：测试本地服务
.\test_tunnel.bat

# 终端3：启动内网穿透
.\start_tunnel_localtunnel.bat
# 复制显示的 URL，例如：https://xxxx.loca.lt

# 终端4：测试公网访问
.\test_tunnel_public.bat https://xxxx.loca.lt

# 或在浏览器访问（推荐使用测试接口）
# https://xxxx.loca.lt/api/test
```

## 成功标志

如果看到以下情况，说明内网穿透**成功**：

1. ✅ 本地服务返回正常数据（`http://localhost:5000/api/test`）
2. ✅ 内网穿透显示公网 URL
3. ✅ 公网 URL 可以访问（浏览器或 curl 测试 `/api/test`）
4. ✅ 返回的 JSON 包含 `"success": true` 和 `"status": "online"`
5. ✅ 健康检查接口正常（`/api/health` 返回 `"status": "healthy"`）

**测试接口返回示例**：
```json
{
  "success": true,
  "message": "服务运行正常",
  "timestamp": "2025-12-05 23:00:00",
  "service": "公考题库分析服务",
  "status": "online"
}
```

## 注意事项

1. **localtunnel 的 URL 每次启动都会变化**
2. **localtunnel 可能不稳定**，如果经常失败，建议使用 cpolar 或 ngrok
3. **免费服务可能有流量限制**，注意使用量
4. **生产环境建议使用固定域名的服务**（如 cpolar 付费版）

